<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mov Player (Smart Scan Support)</title>
    <style>
        /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        html { background-color: #000000; height: 100%; }
        body { background-color: #000000; color: #000000; font-family: sans-serif; margin: 0; padding: 0; height: 100%; overscroll-behavior-y: none; }
        .main-wrapper {
            background-color: #000000; /* ë¦¬ìŠ¤íŠ¸ í™”ë©´ ë°°ê²½ìƒ‰ */
            min-height: 100%;
            padding: 10px; 
            padding-bottom: 50px; /* ê¸°ì¡´ bodyì˜ íŒ¨ë”©ì„ ì´ë¦¬ë¡œ ì´ë™ */
            box-sizing: border-box;
        }
        * { box-sizing: border-box; }
        a { text-decoration: none; color: inherit; }

        /* ìë§‰ ìŠ¤íƒ€ì¼ */
        video::cue {
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.2;
            text-shadow: 1px 1px 2px #000;
        }

        /* === 1. ì»¨íŠ¸ë¡¤ íŒ¨ë„ === */
        .control-panel {
            text-align: center; margin-bottom: 20px; padding: 15px;
            background-color: #1e1e1e; border-radius: 8px; border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .custom-file-upload:hover { background-color: #0b5ed7; }
        input[type="file"] { display: none; }
        .status-msg { margin-top: 10px; color: #aaa; font-size: 0.9rem; }
        
        /* [ì¶”ê°€] íˆìŠ¤í† ë¦¬ ë²„íŠ¼(ë³´ë¼ìƒ‰) ë° ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .btn-history { background-color: #6f42c1; }
        .btn-history:hover { background-color: #59359a; }
        .history-badge { background: #6f42c1; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; vertical-align: middle; margin-left: 5px; display: none; }

        /* [ì¶”ê°€] íˆìŠ¤í† ë¦¬ ì•„ì´í…œ í…Œë‘ë¦¬ ë° ì‚­ì œ ë²„íŠ¼ */
        .item.history-item { border: 1px solid #6f42c1; }
        .btn-search { background-color: #0dcaf0; color: #000; }
        .btn-delete-hist { background-color: #333; color: #aaa; max-width: 30px;}

        /* === 2. ê·¸ë¦¬ë“œ ë¦¬ìŠ¤íŠ¸ === */
        .container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-width: 1200px; margin: 0 auto;
        }
        .item {
            background-color: #1e1e1e; border-radius: 6px; overflow: hidden;
            padding: 8px; text-align: center; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid #333;
            display: flex; flex-direction: column; min-height: 220px;
        }
        .filename {
            font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;
        }
        .video-title {
            font-size: 0.75rem; color: #bbb; margin-bottom: 8px; min-height: 2.4rem;
            line-height: 1.2; word-break: break-all;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .media-container {
            position: relative; width: 100%; padding-top: 66.66%;
            background-color: #000; border-radius: 4px; overflow: hidden; margin-bottom: 8px;
            cursor: pointer;
        }
        .media-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }
        .badge-no {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background-color: #ffc107; color: #000; border-radius: 50%;
            font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none;
        }
        .btn-row { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; width: 100%; }
        .custom-file-upload, .btn-action {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 15px; cursor: pointer; border-radius: 8px;
            font-weight: bold; font-size: 0.9rem; border: none; color: white;
            flex: 1; white-space: nowrap;
        }
        .custom-file-upload { background-color: #0d6efd; margin: 0; }
        .btn-history { background-color: #6f42c1; }
        .btn-back { background-color: #6c757d; }
        .btn-danger { flex: 0 0 auto; padding: 10px 15px; font-size: 0.8rem; }
        /* [ì‹ ê·œ] íˆìŠ¤í† ë¦¬ ê·¸ë£¹ í—¤ë” (í´ë”ëª…) */
        .history-group-title {
            grid-column: 1 / -1; /* ì „ì²´ ë„ˆë¹„ ì°¨ì§€ */
            color: #ffd43b; font-size: 1.1rem; font-weight: bold;
            margin-top: 20px; margin-bottom: 10px; padding-bottom: 5px;
            border-bottom: 2px solid #333;
        }
        /* [ì‹ ê·œ] íˆìŠ¤í† ë¦¬ í´ë” ê·¸ë£¹ ìŠ¤íƒ€ì¼ (ì ‘ê¸°/í¼ì¹˜ê¸°) */
        .history-folder-group { margin-bottom: 5px; border: 1px solid #333; border-radius: 6px; overflow: hidden; }
        .history-folder-header {
            background-color: #222; padding: 15px; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; color: #ffd43b; user-select: none;
        }
        .history-folder-header:hover { background-color: #333; }
        .history-folder-content {
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
            padding: 10px; background-color: #111;
            grid-template-columns: 1fr 1fr; gap: 10px; /* ë‚´ë¶€ ê·¸ë¦¬ë“œ */
        }
        /* í´ë”ê°€ ì—´ë ¸ì„ ë•Œ ì ìš©ë  í´ë˜ìŠ¤ */
        .history-folder-content.open { display: grid; }
                  
        .btn-group { display: flex; gap: 4px; margin-top: auto; }
        .action-btn {
            flex: 1; padding: 10px 0; border: none; border-radius: 4px;
            font-size: 0.85rem; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-play-local { background-color: #198754; }
        .btn-info { background-color: #6c757d; }

        /* === 3. í”Œë ˆì´ì–´ ëª¨ë‹¬ === */
        .modal-overlay {
            display: none; position: fixed; top: 0; bottom: 0; left: 0; right: 0; width: 100%; height: 100%;
            background-color: #000000; z-index: 2000; margin: 0; padding: 0; border: none;
        }
        .video-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; background: #000;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        video { width: 100%; height: 100%; object-fit: contain; background-color: #000; outline: none; }
        video::cue {display: none;}

        .subtitle-overlay {
            position: absolute;
            bottom: 2%;
            left: 0;
            width: 100%;
            text-align: center;
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000, -1px -1px #000;
            padding: 0 10px;
            pointer-events: none; /* í„°ì¹˜ í†µê³¼ */
            z-index: 2040;
            line-height: 1.3;
            white-space: pre-wrap;
        }

        .video-title-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 60px 15px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            color: #fff; font-size: 1rem; font-weight: bold;
            z-index: 2100; pointer-events: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .gesture-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); color: white; padding: 15px 25px; border-radius: 30px;
            font-size: 1.5rem; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 2050;
        }

        .controls-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
            padding: 10px 15px 25px 15px;
            display: flex; flex-direction: column; gap: 10px; z-index: 2100;
        }

        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; }
        .progress-time { font-size: 0.8rem; color: #ddd; min-width: 45px; text-align: center; }
        input[type=range] { flex-grow: 1; -webkit-appearance: none; background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #0d6efd; border-radius: 50%; cursor: pointer; }

        .ctrl-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .ctrl-group { display: flex; align-items: center; gap: 10px; }
        .ctrl-btn { background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        .small-text { font-size: 0.8rem; margin-left: 2px; font-weight: normal; }

        .top-close-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%; width: 36px; height: 36px;
            font-size: 1.2rem; cursor: pointer; z-index: 2200;
            display: flex; align-items: center; justify-content: center;
        }

        /* íŒì—… ë©”ë‰´ */
        .popup-menu {
            position: absolute; bottom: 80px; 
            background-color: rgba(28, 28, 28, 0.95);
            border: 1px solid #444; border-radius: 8px;
            padding: 12px; width: 280px;
            display: none; flex-direction: column; gap: 8px; z-index: 2200;
        }
        #speedMenu { left: 15px; }
        #subMenu { right: 15px; }
        .menu-title { font-size: 0.9rem; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .menu-btn { background: #333; border: 1px solid #555; color: #eee; padding: 6px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; }
        .menu-input { width: 60px; background: #222; border: 1px solid #555; color: #fff; padding: 4px; text-align: center; border-radius: 4px; }

        /* ìë§‰ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ */
        .sub-list-modal {
            position: absolute; top: 0; right: 0; width: 300px; height: 100%;
            background: rgba(20, 20, 20, 0.95); border-left: 1px solid #444;
            z-index: 2300; display: none; flex-direction: column;
            padding: 10px;
        }
        .sub-list-header {
            font-size: 1rem; font-weight: bold; color: #fff; border-bottom: 1px solid #555;
            padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .sub-list-content {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;
        }
        .sub-item {
            padding: 8px; background: #333; border-radius: 4px; color: #ccc; font-size: 0.85rem; cursor: pointer;
            transition: background 0.2s;
        }
        .sub-item:hover { background: #444; color: #fff; }
        .sub-item.active { border-left: 4px solid #0d6efd; background: #2a2a2a; color: #fff; font-weight: bold; }
        .sub-time { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px; }
        .guide-text { font-size: 0.75rem; color: #bbb; padding: 0 5px 10px 5px; line-height: 1.3; }
        /* [ì‹ ê·œ] ë¯¸ë¦¬ë³´ê¸° íŒì—… ìŠ¤íƒ€ì¼ */
        .preview-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .preview-content {
            position: relative;
            max-width: 90%; max-height: 90%;
            background: #000; border-radius: 8px;
            overflow-y: auto; /* ì´ë¯¸ì§€ê°€ ê¸¸ë©´ ìŠ¤í¬ë¡¤ */
            box-shadow: 0 0 20px rgba(0,0,0,0.7);
            border: 1px solid #444;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 300px; min-height: 200px;
        }
        .preview-image {
            display: block; width: 100%; height: auto; object-fit: contain;
        }
        .cache-status-badge {
            position: absolute; bottom: 5px; right: 5px; width: 18px; height: 18px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 10px; z-index: 15; background: rgba(0,0,0,0.7);
            border: 1px solid rgba(255,255,255,0.2); pointer-events: none;
        }
        .status-syncing {
            background: #0d6efd; border-color: #fff;
            box-shadow: 0 0 5px #0d6efd; animation: pulse 1s infinite alternate;
        }
        .status-completed { background: #198754; border-color: #fff; color: #fff; }
        @keyframes pulse { from { transform: scale(0.9); opacity: 0.8; } to { transform: scale(1.1); opacity: 1; } }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="control-panel">
            <!-- ë©”ì¸ ì»¨íŠ¸ë¡¤ -->
            <div id="main-controls" class="btn-row">
                <label for="folder-upload" class="custom-file-upload">ğŸ“‚ í´ë” ìŠ¤ìº”</label>
                <button class="btn-action btn-history" onclick="toggleHistoryMode(true)">ğŸ“œ íˆìŠ¤í† ë¦¬ <span id="historyCount" class="history-badge">0</span></button>
            </div>
            <!-- íˆìŠ¤í† ë¦¬ ì»¨íŠ¸ë¡¤ -->
            <div id="history-controls" class="btn-row" style="display:none;">
                <button class="btn-action btn-back" onclick="toggleHistoryMode(false)">â†©ï¸ ëª©ë¡ìœ¼ë¡œ</button>
                <button class="btn-action btn-danger" onclick="clearThumbnailCache()">ğŸ—‘ï¸ ìºì‹œì‚­ì œ</button>
                <button class="btn-action btn-danger" style="background:#b02a37" onclick="clearHistory()">ğŸ’£ ì´ˆê¸°í™”</button>
            </div>
            
            <input id="folder-upload" type="file" webkitdirectory directory multiple />
            <div id="cacheStatus" class="status-msg">DB ì¤€ë¹„ ì¤‘...</div>
            <div id="status" class="status-msg" style="color:#fff; margin-top:8px;">í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div>
        </div>
    
        <!-- ìŠ¤ìº” ê²°ê³¼ ê°¤ëŸ¬ë¦¬ -->
        <div id="gallery-scan" class="container"></div>
        
        <!-- íˆìŠ¤í† ë¦¬ ê°¤ëŸ¬ë¦¬ (ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘) -->
        <div id="gallery-history" class="container" style="display:none;"></div>
    </div>
<!-- [ì‹ ê·œ] 4ë¶„í•  ë¯¸ë¦¬ë³´ê¸° íŒì—… -->
    <div id="previewModal" class="preview-modal" onclick="closePreviewModal()">
        <div class="preview-content" onclick="event.stopPropagation()">
            <img id="previewImage" class="preview-image" src="" alt="ë¯¸ë¦¬ë³´ê¸° ë¡œë”© ì¤‘...">
            <div id="previewLoading" style="padding:20px; color:#fff; text-align:center; display:none;">
                â³ ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘...
            </div>
        </div>
        <button class="top-close-btn" style="position:fixed; top:20px; right:20px;" onclick="closePreviewModal()">âœ•</button>
    </div>
    <div id="videoModal" class="modal-overlay">
        <div id="videoWrapper" class="video-wrapper">
            <div id="videoTitleBar" class="video-title-bar"></div>
            <div id="gestureFeedback" class="gesture-overlay">00:00</div>
            
            <video id="mainPlayer" playsinline onclick="toggleControls()" crossorigin="anonymous"></video>
            <div id="customSubTitle" class="subtitle-overlay"></div> 
            <button class="top-close-btn" onclick="closeModal()">âœ•</button>

            <!-- ìë§‰ ë¦¬ìŠ¤íŠ¸ (ì†ë„ ì‹±í¬ìš©) -->
            <div id="subListModal" class="sub-list-modal" onclick="event.stopPropagation()">
                <div class="sub-list-header">
                    <span>ğŸ“‘ ìë§‰ ì†ë„ ë§ì¶¤ (Speed Sync)</span>
                    <button onclick="toggleSubList()" style="background:none; border:none; color:#fff; cursor:pointer;">âœ•</button>
                </div>
                <div class="guide-text">
                    * ì˜ìƒì—ì„œ ë“¤ë¦¬ëŠ” ëŒ€ì‚¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.<br>
                    * í•´ë‹¹ ëŒ€ì‚¬ê°€ í˜„ì¬ ì‹œê°„ì— ì˜¤ë„ë¡ <strong>ì „ì²´ ìë§‰ ì†ë„</strong>ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
                </div>
                <div id="subListContent" class="sub-list-content">
                    <div style="color:#777; font-size:0.8rem; padding:10px;">ìë§‰ ì—†ìŒ</div>
                </div>
            </div>

            <div id="controlsBar" class="controls-bar">
                <div class="progress-container">
                    <span id="currentTimeText" class="progress-time">0:00</span>
                    <input type="range" id="seekBar" value="0" step="0.1" min="0">
                    <span id="durationText" class="progress-time">0:00</span>
                </div>

                <div class="ctrl-row">
                    <div class="ctrl-group">
                        <button class="ctrl-btn" onclick="togglePlay()" id="playIcon">â–¶</button>
                        <button class="ctrl-btn" style="font-size:1.1rem" onclick="seek(-10)">âª</button>
                        <button class="ctrl-btn" style="font-size:1.1rem" onclick="seek(10)">â©</button>
                        <button class="ctrl-btn" onclick="toggleMenu('speedMenu')">âš¡<span id="speedBtnText" class="small-text">1.0</span></button>
                    </div>
                    <div class="ctrl-group">
                        <button class="ctrl-btn" onclick="toggleSubList()" title="ìë§‰ ë¦¬ìŠ¤íŠ¸ & ì†ë„ ì‹±í¬">ğŸ“‘</button>
                        <button class="ctrl-btn" onclick="toggleMenu('subMenu')">ğŸ’¬</button>
                        <button class="ctrl-btn" onclick="toggleFullscreen()">â›¶</button>
                    </div>
                </div>
            </div>

            <div id="speedMenu" class="popup-menu" onclick="event.stopPropagation()">
                <div class="menu-title">ì˜ìƒ ì¬ìƒ ì†ë„</div>
                <div class="menu-row">
                    <button class="menu-btn" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="menu-btn" onclick="setSpeed(1.2)">1.2x</button>
                    <button class="menu-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="menu-btn" onclick="setSpeed(2.0)">2.0x</button>
                </div>
            </div>

            <div id="subMenu" class="popup-menu" onclick="event.stopPropagation()">
                <div class="menu-title">ìë§‰ ì†ë„ (Stretch) ìˆ˜ë™ ì…ë ¥</div>
                <div class="menu-row">
                    <input type="number" id="subStretchInput" class="menu-input" placeholder="98.55">
                    <span style="font-size:0.8rem">%</span>
                    <button class="menu-btn" onclick="applySubtitleStretchManual()">ì ìš©</button>
                </div>
                <div style="margin-top:5px;">
                    <button class="menu-btn" style="width:100%" onclick="resetSubtitleFactor()">â†º ì†ë„ ì´ˆê¸°í™” (100%)</button>
                </div>
                
                <div class="menu-title" style="margin-top:8px;">ìë§‰ íŒŒì¼ ì—´ê¸°</div>
                <div class="menu-row">
                    <input id="sub-upload" type="file" accept=".srt, .srn .vtt" onchange="loadSubtitleManual(this)" style="display:none;" />
                    <label for="sub-upload" class="menu-btn" style="width:100%; text-align:center; background:#444;">ğŸ“‚ ìë§‰ ì„ íƒ</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === IndexedDB ì„¤ì • ===
        const DB_NAME = 'JavPlayerDB_V2', THUMB_STORE = 'thumbnails', HISTORY_STORE = 'history';
        let db;
        let isHistoryMode = false;
        
        function initDB() {
            // ë²„ì „ 2 -> 3ìœ¼ë¡œ ì¦ê°€ (ìŠ¤í‚¤ë§ˆ ë³€ê²½ì„ ìœ„í•´ í•„ìˆ˜)
            const req = indexedDB.open(DB_NAME, 3);
            
            req.onupgradeneeded = e => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(THUMB_STORE)) d.createObjectStore(THUMB_STORE);
                
                // ê¸°ì¡´ history ìŠ¤í† ì–´ê°€ ìˆë‹¤ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ìƒì„± (KeyPath ë³€ê²½: filename -> path)
                if (d.objectStoreNames.contains(HISTORY_STORE)) {
                    d.deleteObjectStore(HISTORY_STORE);
                }
                d.createObjectStore(HISTORY_STORE, { keyPath: 'path' });
            };
            req.onsuccess = e => { db = e.target.result; updateCacheStatus(); updateHistoryCount(); };
        }
        initDB();
        
        function getCacheKey(file) { return `${file.name}_${file.size}_${file.lastModified}`; }
        
        // === DB í—¬í¼ ===
        function updateCacheStatus() {
            if (!db) return;
            const t = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).count();
            t.onsuccess = () => { document.getElementById('cacheStatus').innerText = `ì €ì¥ëœ ì¸ë„¤ì¼: ${t.result}ê°œ`; };
        }
        function updateHistoryCount() {
            if(!db) return;
            const t = db.transaction(HISTORY_STORE, 'readonly').objectStore(HISTORY_STORE).count();
            t.onsuccess = () => {
                const span = document.getElementById('historyCount');
                span.innerText = t.result; span.style.display = t.result > 0 ? 'inline-block' : 'none';
            };
        }
        function clearThumbnailCache() {
            if (!confirm("ì¸ë„¤ì¼ ìºì‹œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const tx = db.transaction(THUMB_STORE, 'readwrite');
            tx.objectStore(THUMB_STORE).clear();
            tx.oncomplete = () => { alert("ì‚­ì œë¨"); updateCacheStatus(); };
        }
        function clearHistory() {
            if (!confirm("íˆìŠ¤í† ë¦¬ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const tx = db.transaction(HISTORY_STORE, 'readwrite');
            tx.objectStore(HISTORY_STORE).clear();
            tx.oncomplete = () => { alert("ì´ˆê¸°í™”ë¨"); updateHistoryCount(); if(isHistoryMode) renderHistoryView(); };
        }
        function addToHistory(filename, title, fileId, path, thumbnailBlob = null, fileMeta = null) {
            if(!db) return;
            const tx = db.transaction(HISTORY_STORE, 'readwrite');
            const store = tx.objectStore(HISTORY_STORE);
            
            // pathë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì¡°íšŒ (íŒŒì¼ëª… ì¤‘ë³µ ë¬¸ì œ í•´ê²°)
            const getReq = store.get(path);
            
            getReq.onsuccess = () => {
                const existing = getReq.result;
                const finalThumb = thumbnailBlob || (existing ? existing.thumbnail : null);
                
                // ë©”íƒ€ë°ì´í„°(í¬ê¸°, ìˆ˜ì •ì¼) í•„ìˆ˜ ì €ì¥
                // fileMetaê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ì‚¬ìš©, ê·¸ë˜ë„ ì—†ìœ¼ë©´ 0
                const finalSize = fileMeta ? fileMeta.size : (existing ? existing.size : 0);
                const finalMod = fileMeta ? fileMeta.lastModified : (existing ? existing.lastModified : 0);

                let finalTitle = title;
                // ê¸°ì¡´ ì œëª©ì´ ìœ íš¨í•˜ë©´ ìœ ì§€
                if (existing && existing.title && existing.title !== "ì œëª© í™•ì¸ ì¤‘..." && existing.title !== "ID ì¶”ì¶œ ì‹¤íŒ¨" && (title === "ì œëª© í™•ì¸ ì¤‘..." || title === "ID ì¶”ì¶œ ì‹¤íŒ¨")) {
                    finalTitle = existing.title;
                }
                
                store.put({
                    path: path, // KeyPath (ê³ ìœ ê°’)
                    filename: filename, 
                    title: finalTitle, 
                    fileId: fileId, 
                    thumbnail: finalThumb, 
                    size: finalSize, 
                    lastModified: finalMod,
                    timestamp: existing ? existing.timestamp : new Date().getTime()
                });
            };
            tx.oncomplete = updateHistoryCount;
        }
        function updateHistoryTitle(path, newTitle) {
            if(!db) return;
            const tx = db.transaction(HISTORY_STORE, 'readwrite');
            const store = tx.objectStore(HISTORY_STORE);
            const req = store.get(path); // ê²½ë¡œë¡œ ì¡°íšŒ
            req.onsuccess = () => {
                const item = req.result;
                if(item) { item.title = newTitle; store.put(item); }
            };
        }
        function deleteFromHistory(path) {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const tx = db.transaction(HISTORY_STORE, 'readwrite');
            tx.objectStore(HISTORY_STORE).delete(path); // ê²½ë¡œë¡œ ì‚­ì œ
            tx.oncomplete = () => { renderHistoryView(); updateHistoryCount(); };
        }
        
        // === ì „ì—­ ë³€ìˆ˜ ===
        let loadedVideos = [];
        let subtitleMap = {};
        let titleCache = {}; // ìŠ¤ìº” ëª¨ë“œìš© ì¸ë±ìŠ¤ ìºì‹œ
        let titleQueue = [];
        let isBatchRunning = false;
        const BATCH_SIZE = 20;
        
        // ==========================================
        // 1. íŒŒì¼ ìŠ¤ìº”
        // ==========================================
        document.getElementById('folder-upload').addEventListener('change', function(event) {
            if(isHistoryMode) toggleHistoryMode(false);
            
            const files = Array.from(event.target.files);
            const gallery = document.getElementById('gallery-scan');
            const status = document.getElementById('status');
            
            loadedVideos = []; subtitleMap = {}; titleQueue = []; titleCache = {};
            gallery.innerHTML = '';
        
            files.forEach(f => {
                // [â–¼â–¼â–¼ ì¶”ê°€ëœ ì½”ë“œ ì‹œì‘ â–¼â–¼â–¼]
                // webkitRelativePath ì˜ˆì‹œ: "ìµœìƒìœ„í´ë”/íŒŒì¼ëª…" (length=2) ë˜ëŠ” "ìµœìƒìœ„í´ë”/í•˜ìœ„í´ë”/íŒŒì¼ëª…" (length>2)
                // ë”°ë¼ì„œ '/'ë¡œ ìª¼ê°°ì„ ë•Œ ê°œìˆ˜ê°€ 2ê°œë¥¼ ë„˜ìœ¼ë©´ í•˜ìœ„ í´ë”ì— ìˆëŠ” íŒŒì¼ì´ë¯€ë¡œ ê±´ë„ˆëœë‹ˆë‹¤.
                if (f.webkitRelativePath && f.webkitRelativePath.split('/').length > 2) {
                    return; 
                }
                // [â–²â–²â–² ì¶”ê°€ëœ ì½”ë“œ ë â–²â–²â–²]

                const n = f.name.toLowerCase();
                if (f.type.startsWith('video/') || n.match(/\.(mp4|avi|mkv|wmv|mov|webm|m4v|nel|nep)$/)) loadedVideos.push(f);
                else if (n.endsWith('.srt') || n.endsWith('.srn')) subtitleMap[n.substring(0, n.lastIndexOf('.'))] = f;
            });
        
            if (loadedVideos.length === 0) { status.innerText = "ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤. (í•˜ìœ„ í´ë” ì œì™¸)"; return; } // ë¬¸êµ¬ ì‚´ì§ ìˆ˜ì •
            loadedVideos.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            status.innerText = `ìŠ¤ìº” ì™„ë£Œ: ì˜ìƒ ${loadedVideos.length}ê°œ`;
        
            loadedVideos.forEach((file, index) => {
                const nameNoExt = file.name.substring(0, file.name.lastIndexOf('.'));
                const fileInfo = parseFileId(nameNoExt);
                const fileId = fileInfo.id;
                const fullPath = file.webkitRelativePath || file.name;
                
                addToHistory(file.name, "ì œëª© í™•ì¸ ì¤‘...", fileId, fullPath, null, {size: file.size, lastModified: file.lastModified});
        
                const uncensoredId = fileId + "-uncensored-leak";        
                const divId = `media-${index}`;
                const targetUrl = `https://missav.live/ko/${fileId}`;
                const uncThumb = `https://wsrv.nl/?url=fourhoi.com/${uncensoredId}/cover-t.jpg&q=70`;
                const stdThumb = `https://wsrv.nl/?url=fourhoi.com/${fileId}/cover-t.jpg&q=70`;
        
                const itemHtml = `
                    <div class="item">
                        <div class="filename">${file.name}</div>
                        <div class="video-title" id="title-${index}">...</div>
                        <div id="${divId}" class="media-container">
                            <div class="badge-no">ë…¸</div>
                            <img src="${uncThumb}" data-fallback="${stdThumb}" data-index="${index}" data-fileid="${fileId}"
                                class="media-content"
                                onclick="playWebPreview('${divId}', 'https://fourhoi.com/${uncensoredId}/preview.mp4', '${targetUrl}')"
                                onerror="onThumbnailError(this)" onload="onWebThumbLoad(this)">
                        </div>
                        <div class="btn-group">
                            <button class="action-btn btn-play-local" onclick="playLocalVideo(${index})">â–¶ ì¬ìƒ</button>
                            <button class="action-btn btn-info" onclick="window.open('${targetUrl}', '_blank')">ğŸ”— ì •ë³´</button>
                        </div>
                    </div>`;
                gallery.insertAdjacentHTML('beforeend', itemHtml);
                
                if (fileInfo.isRecognized) {
                    // [ìˆ˜ì •] íì— path ì •ë³´ ì¶”ê°€ (ì œëª© ì—…ë°ì´íŠ¸ ì‹œ í•„ìš”)
                    addToQueue({ type: 'scan', id: fileId, index: index, filename: file.name, path: fullPath });
                } else {
                    document.getElementById(`title-${index}`).innerText = "ID ì¶”ì¶œ ì‹¤íŒ¨";
                    // [ìˆ˜ì •] ì œëª© ì—…ë°ì´íŠ¸ ì‹œ fullPath ì‚¬ìš©
                    updateHistoryTitle(fullPath, "ID ì¶”ì¶œ ì‹¤íŒ¨");
                }
            });
        });
        
        // ==========================================
        // 2. ì œëª© ê°€ì ¸ì˜¤ê¸° (í†µí•© í ì‹œìŠ¤í…œ)
        // ==========================================
        function addToQueue(item) {
            // item: { type: 'scan'|'history', id: '...', index/domId: '...', filename: '...' }
            item.retries = 0;
            titleQueue.push(item);
            processBatch();
        }
        
        async function processBatch() {
            if (isBatchRunning || titleQueue.length === 0) return;
            isBatchRunning = true;
            const batch = titleQueue.splice(0, BATCH_SIZE);
            
            await Promise.allSettled(batch.map(item => fetchTitleMissAV(item)));
            setTimeout(() => { isBatchRunning = false; processBatch(); }, 500);
        }
        
        async function fetchTitleMissAV(item) {
            // íƒ€ê²Ÿ ì—˜ë¦¬ë¨¼íŠ¸ ì°¾ê¸°
            let targetEl = null;
            if (item.type === 'scan') targetEl = document.getElementById(`title-${item.index}`);
            else if (item.type === 'history') targetEl = document.getElementById(item.domId);
        
            if (targetEl) targetEl.innerText = "í™•ì¸ ì¤‘...";
        
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://www.njav.com/ko/xvideos/${item.id}`)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Net");
                
                const htmlText = await response.text();                
                let rawTitle = "";
                const ogMatch = htmlText.match(/<meta property="og:title" content="(.*?)">/i);
                
                if (ogMatch && ogMatch[1]) {
                    rawTitle = ogMatch[1];
                } else {
                    // ìš°ì„ ìˆœìœ„ 2: title íƒœê·¸
                    const titleMatch = htmlText.match(/<title>(.*?)<\/title>/i);
                    if (titleMatch && titleMatch[1]) rawTitle = titleMatch[1];
                }

                if (rawTitle) {
                    // 4. ì œëª© ì •ì œ (ì²­ì†Œ) ì‘ì—…
                    // ì›ë³¸ ì˜ˆì‹œ: "nJAV.com - ì‹œì²­ IPZ-020 ëŒ€ìƒ OLâ€¦ ìŠ¤í† ì»¤ ì´ì¿ ë‹¤ì¼€ ë¯¸ë„¤ HDì—ì„œ ë¬´ë£Œë¡œ JAV ì˜¨ë¼ì¸ ì‹œì²­"
                    
                    let cleanTitle = rawTitle;                    

                    // ë¶ˆí•„ìš”í•œ ê´‘ê³ /ì‚¬ì´íŠ¸ ë¬¸êµ¬ ì œê±°
                    cleanTitle = cleanTitle.replace(/nJAV\.com/gi, ""); // ì‚¬ì´íŠ¸ëª… ì œê±°                    
                    cleanTitle = cleanTitle.replace(/ì‹œì²­/g, "");        // "ì‹œì²­" ì œê±°                    
                    cleanTitle = cleanTitle.replace(/HDì—ì„œ ë¬´ë£Œë¡œ JAV ì˜¨ë¼ì¸/g, ""); // ë’¤ìª½ ë¬¸êµ¬ ì œê±°                                        
                    
                    // í’ˆë²ˆ ì œê±° (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                    cleanTitle = cleanTitle.replace(new RegExp(item.id, 'gi'), '').trim();
                    
                    // íŠ¹ìˆ˜ë¬¸ì ì •ë¦¬ (ì•ë’¤ì— ë‚¨ì€ -, :, ê³µë°± ë“± ì œê±°)
                    cleanTitle = cleanTitle.replace(/^[-â€“\s:ï¼š]+/, '').replace(/[-â€“\s:ï¼š]+$/, '');
                    
                    // ë„ˆë¬´ ì§§ìœ¼ë©´(ì œëª©ì´ ë‹¤ ì§€ì›Œì¡Œìœ¼ë©´) ì‹¤íŒ¨ ì²˜ë¦¬
                    if (!cleanTitle || cleanTitle.length < 2) throw new Error("Title empty");
                    if (targetEl) {
                        targetEl.innerText = cleanTitle;
                        targetEl.style.color = "#fff";
                    }
                    // ìŠ¤ìº” ëª¨ë“œë©´ ìºì‹œ ì €ì¥
                    if (item.type === 'scan') titleCache[item.index] = cleanTitle;
                    // [ì¤‘ìš”] DB ì—…ë°ì´íŠ¸ (íˆìŠ¤í† ë¦¬)
                    updateHistoryTitle(item.path || item.filename, cleanTitle);
                    return;
                }
                throw new Error("Parse Fail");
            } catch (e) {
                item.retries++;
                if (item.retries < 2) {
                    titleQueue.push(item); // ì¬ì‹œë„
                } else {
                    if (targetEl) targetEl.innerText = "ì œëª© ì—†ìŒ";
                    // ì‹¤íŒ¨ ì‹œ DBì—ëŠ” ì €ì¥ ì•ˆ í•˜ê±°ë‚˜ 'ì œëª© ì—†ìŒ' ì €ì¥ (ì„ íƒì‚¬í•­)
                    // updateHistoryTitle(item.filename, "ì œëª© ì—†ìŒ");
                }
            }
        }
        
        
        // ==========================================
        // 3. íˆìŠ¤í† ë¦¬ ëª¨ë“œ (í´ë” ì•„ì½”ë””ì–¸, ì œëª© ìë™ê°±ì‹ )
        // ==========================================
        function toggleHistoryMode(showHistory) {
            isHistoryMode = showHistory;
            const scanDiv = document.getElementById('gallery-scan');
            const histDiv = document.getElementById('gallery-history');
            const status = document.getElementById('status');
            const mainCtrl = document.getElementById('main-controls');
            const histCtrl = document.getElementById('history-controls');
        
            if (showHistory) {
                scanDiv.style.display = 'none';
                histDiv.style.display = 'block'; // Block for accordion
                mainCtrl.style.display = 'none';
                histCtrl.style.display = 'flex';
                status.innerText = "ğŸ“š íˆìŠ¤í† ë¦¬ ëª¨ë“œ (í´ë”ëª…ì„ ëˆ„ë¥´ì„¸ìš”)";
                renderHistoryView();
            } else {
                scanDiv.style.display = 'grid';
                histDiv.style.display = 'none';
                mainCtrl.style.display = 'flex';
                histCtrl.style.display = 'none';
                if(loadedVideos.length > 0) status.innerText = `ìŠ¤ìº” ì™„ë£Œ: ì˜ìƒ ${loadedVideos.length}ê°œ`;
                else status.innerText = "í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.";
            }
        }
        
        function renderHistoryView() {
            if(!db) return;
            const gallery = document.getElementById('gallery-history');
            gallery.innerHTML = '<div style="color:#777; padding:20px; text-align:center;">ë¡œë”© ì¤‘...</div>';
            
            const tx = db.transaction(HISTORY_STORE, 'readonly').objectStore(HISTORY_STORE).getAll();
            tx.onsuccess = () => {
                const list = tx.result;
                if(!list || list.length === 0) {
                    gallery.innerHTML = '<div style="padding:20px; color:#aaa; text-align:center;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }
        
                const groups = {};
                list.forEach(item => {
                    let folderName = "ê¸°íƒ€ (ê²½ë¡œ ì—†ìŒ)";
                    if (item.path) {
                        const parts = item.path.split('/');
                        if (parts.length > 1) { parts.pop(); folderName = parts.join(' / '); }
                        else folderName = "ìµœìƒìœ„ í´ë” (Root)";
                    }
                    if(!groups[folderName]) groups[folderName] = [];
                    groups[folderName].push(item);
                });
        
                gallery.innerHTML = '';
                const sortedFolders = Object.keys(groups).sort();
                let globalIndex = 0;
        
                sortedFolders.forEach((folder, folderIdx) => {
                    const items = groups[folder].reverse();
                    const folderId = `folder-content-${folderIdx}`;
                    
                    const headerHtml = `
                        <div class="history-folder-group">
                            <div class="history-folder-header" onclick="toggleFolder('${folderId}')">
                                <span>ğŸ“‚ ${folder}</span>
                                <span style="font-size:0.8rem; color:#888;">${items.length}ê°œ</span>
                            </div>
                            <div id="${folderId}" class="history-folder-content"></div>
                        </div>`;
                    gallery.insertAdjacentHTML('beforeend', headerHtml);
                    
                    const contentDiv = document.getElementById(folderId);
                    items.forEach(item => {
                        const domTitleId = `hist-title-${globalIndex}`;
                        const domMediaId = `hist-media-${globalIndex}`; 
                        const domBadgeId = `hist-badge-${globalIndex}`; // [ì‹ ê·œ] ë±ƒì§€ ì œì–´ìš© ID
                        globalIndex++;
                        
                        let thumbSrc = "";
                        let isLocal = false;
                        let clickAction = "";
                        let badgeHtml = "";
                        
                        // í‘œì¤€ ì •ë³´ (fallbackìš©)
                        const stdThumb = `https://wsrv.nl/?url=fourhoi.com/${item.fileId}/cover-t.jpg&q=70`;
                        const targetUrl = `https://missav.live/ko/${item.fileId}`;
        
                        // [ì¤‘ìš”] 1. ë¡œì»¬ íŒŒì¼
                        if (item.thumbnail) { 
                            thumbSrc = URL.createObjectURL(item.thumbnail); 
                            isLocal = true; 
                            badgeHtml = '<div class="cache-status-badge status-completed">âœ…</div>';
                            
                            if(item.size && item.lastModified) {
                                clickAction = `onclick="openHistoryLocalPreview('${item.filename.replace(/'/g, "\\'")}', ${item.size}, ${item.lastModified})"`;
                            } else {
                                clickAction = `onclick="alert('ë©”íƒ€ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.')"`;
                            }
                        } 
                        // [ì¤‘ìš”] 2. ì›¹ íŒŒì¼ (ë…¸ëª¨ ìš°ì„  ë¡œì§ ì ìš©)
                        else { 
                            const uncensoredId = item.fileId + "-uncensored-leak";
                            // ê¸°ë³¸ì ìœ¼ë¡œ ë…¸ëª¨ ì¸ë„¤ì¼ ì‹œë„
                            thumbSrc = `https://wsrv.nl/?url=fourhoi.com/${uncensoredId}/cover-t.jpg&q=70`; 
                            const previewVideoUrl = `https://fourhoi.com/${uncensoredId}/preview.mp4`;
        
                            // ë…¸ëª¨ ë¯¸ë¦¬ë³´ê¸° ì—°ê²° (ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í•¸ë“¤ëŸ¬ì—ì„œ ë±ƒì§€ ìˆ¨ê¹€ ì²˜ë¦¬)
                            clickAction = `onclick="playWebPreview('${domMediaId}', '${previewVideoUrl}', '${targetUrl}')"`;
                            
                            // ê¸°ë³¸ì ìœ¼ë¡œ ë…¸ëª¨ ë±ƒì§€ í‘œì‹œ, Web ë±ƒì§€ í‘œì‹œ
                            badgeHtml = `
                                <div id="${domBadgeId}" class="badge-no">ë…¸</div>
                                <div class="badge-no" style="background:#555; right:5px; left:auto; width:auto; padding:0 5px; border-radius:4px;">Web</div>
                            `;
                        }
                        
                        let displayTitle = item.title;
                        if (!displayTitle || displayTitle === "ì œëª© í™•ì¸ ì¤‘...") {
                            displayTitle = "ì œëª© í™•ì¸ ì¤‘...";
                            if (item.fileId && item.fileId !== "unknown" && item.title !== "ID ì¶”ì¶œ ì‹¤íŒ¨") {
                                addToQueue({ type: 'history', id: item.fileId, domId: domTitleId, filename: item.filename, path: item.path });
                            }
                        }
                        const folderInfo = item.path ? item.path.replace(item.filename, '') : "ê²½ë¡œ ì •ë³´ ì—†ìŒ";
        
                        // onHistoryThumbErrorì— stdThumbì™€ domBadgeId ì „ë‹¬
                        const itemHtml = `
                            <div class="item history-item">
                                <div class="filename" style="color:#b197fc; cursor:pointer; text-decoration:underline;" 
                                        onclick="alert('ğŸ“‚ ì›ë˜ ìœ„ì¹˜:\\n${folderInfo}')">
                                    ${item.filename}
                                </div>
                                <div class="video-title" id="${domTitleId}">${displayTitle}</div>
                                
                                <div id="${domMediaId}" class="media-container" ${clickAction} style="cursor:pointer;">
                                    <img src="${thumbSrc}" class="media-content" style="opacity:${isLocal?1:0.8}"
                                            onerror="onHistoryThumbError(this, '${stdThumb}', '${domBadgeId}', '${domMediaId}', '${targetUrl}')">
                                    ${badgeHtml}
                                </div>
        
                                <div class="btn-group">
                                    <button class="action-btn btn-search" onclick="window.open('${targetUrl}', '_blank')">ğŸ” GO</button>
                                    <button class="action-btn btn-delete-hist" onclick="deleteFromHistory('${item.path.replace(/'/g, "\\'")}')">âœ•</button>
                                </div>
                            </div>`;
                        contentDiv.insertAdjacentHTML('beforeend', itemHtml);
                    });
                });
            };
        }
        function openHistoryLocalPreview(filename, size, lastModified) {
            // [ìˆ˜ì •] getCacheKeyëŠ” file.nameì„ ì‚¬ìš©í•˜ë¯€ë¡œ, name ì†ì„±ì— filenameì„ í• ë‹¹í•´ì•¼ í•¨
            const dummyFile = { name: filename, size: size, lastModified: lastModified };
            const previewKey = getCacheKey(dummyFile) + "_preview";
            
            const modal = document.getElementById('previewModal');
            const img = document.getElementById('previewImage');
            const loading = document.getElementById('previewLoading');

            img.style.display = 'none';
            img.src = '';
            loading.style.display = 'block';
            modal.style.display = 'flex';
            
            if(!db) { alert("DB ë¯¸ë¡œë“œ"); return; }

            const req = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).get(previewKey);
            req.onsuccess = () => {
                if (req.result) {
                    img.src = URL.createObjectURL(req.result);
                    img.style.display = 'block';
                    loading.style.display = 'none';
                } else {
                    // í”„ë¦¬ë·°ê°€ ì—†ìœ¼ë©´ ì›ë³¸ ì¸ë„¤ì¼ì´ë¼ë„ ë³´ì—¬ì£¼ê¸° ì‹œë„
                    const mainKey = getCacheKey(dummyFile);
                    const mainReq = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).get(mainKey);
                    mainReq.onsuccess = () => {
                        if(mainReq.result) {
                            img.src = URL.createObjectURL(mainReq.result);
                            img.style.display = 'block';
                            loading.style.display = 'none';
                        } else {
                            alert("ì €ì¥ëœ ë¯¸ë¦¬ë³´ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. (íŒŒì¼ì„ ë‹¤ì‹œ ìŠ¤ìº”í•˜ë©´ ìƒì„±ë©ë‹ˆë‹¤)");
                            closePreviewModal();
                        }
                    }
                }
            };
        }
        // í´ë” í† ê¸€ í•¨ìˆ˜
        function toggleFolder(id) {
            const el = document.getElementById(id);
            if(el.style.display === 'grid') el.style.display = 'none';
            else el.style.display = 'grid';
        }
        
        function onHistoryThumbError(img, fallbackUrl, badgeId, mediaId, targetUrl) {
            // ì´ë¯¸ fallbackìœ¼ë¡œ ë°”ë€ ìƒíƒœë¼ë©´ ê¸°ë³¸ ì—ëŸ¬ ì´ë¯¸ì§€ ì²˜ë¦¬
            if (img.src === fallbackUrl) {
                img.onerror = null; 
                img.src = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiMzMzMiLz48dGV4dCB4PSI1MCIgeT0iNTAiIGZpbGw9IiM3NzciIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5ObzwvdGV4dD48L3N2Zz4='; 
                img.style.opacity = 0.3;
                // ë±ƒì§€ë„ ìˆ¨ê¹€
                const badge = document.getElementById(badgeId);
                if(badge) badge.style.display = 'none';
            } else {
                // ë…¸ëª¨ ì¸ë„¤ì¼ ì‹¤íŒ¨ -> ì¼ë°˜ ì¸ë„¤ì¼ë¡œ êµì²´
                img.src = fallbackUrl;
                
                // "ë…¸" ë±ƒì§€ ìˆ¨ê¸°ê¸°
                const badge = document.getElementById(badgeId);
                if(badge) badge.style.display = 'none';
        
                // [ì¤‘ìš”] í´ë¦­ ì•¡ì…˜ë„ ë…¸ëª¨ ë¯¸ë¦¬ë³´ê¸° -> ì¼ë°˜ ë§í¬/ë¯¸ë¦¬ë³´ê¸°ë¡œ ë³€ê²½í•´ì•¼ í•¨
                // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ í´ë¦­ ì‹œ ë¯¸ë¦¬ë³´ê¸° ëŒ€ì‹  ë°”ë¡œ ìƒˆì°½ ì´ë™í•˜ë„ë¡ ë³€ê²½ (ë¯¸ë¦¬ë³´ê¸° ì˜ìƒì´ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
                const container = document.getElementById(mediaId);
                if(container) {
                    // ê¸°ì¡´ onclick ì†ì„±ì„ ë®ì–´ì”Œì›€
                    container.onclick = function() { window.open(targetUrl, '_blank'); };
                }
            }
        }
        
        // ==========================================
        // 4. ê¸°íƒ€ ìœ í‹¸ & í”Œë ˆì´ì–´ (ë³€ê²½ ì—†ìŒ)
        // ==========================================
        function parseFileId(nameNoExt) {
            const fc2Match = nameNoExt.match(/fc2[-\s\.]?(?:ppv)?[-\s\.]?(\d+)/i);
            const caribMatch = nameNoExt.match(/carib(?:beancom)?[-\s\.]?(\d{6})[-\s\.]?(\d{3})/i);
            const mixedDateMatch = nameNoExt.match(/(\d{6})([-_])(\d{2,3})/);
            const dateMatch = nameNoExt.match(/(\d{6})[-\s\.]?(\d{3,})/);
            const nMatch = nameNoExt.match(/n(\d{3,5})/i);
            const stdMatch = nameNoExt.match(/([a-z]+)[-\s\.]?(\d+)/i);
            if (fc2Match) return { id: `fc2-ppv-${fc2Match[1]}`, isRecognized: true };
            if (caribMatch) return { id: `caribbeancom-${caribMatch[1]}-${caribMatch[2]}`, isRecognized: true };
            if (mixedDateMatch) return { id: `${mixedDateMatch[1]}${mixedDateMatch[2]}${mixedDateMatch[3]}`, isRecognized: true };
            if (dateMatch) return { id: `${dateMatch[1]}-${dateMatch[2]}`, isRecognized: true };
            if (nMatch) return { id: `n${nMatch[1]}`, isRecognized: true };
            if (stdMatch) return { id: `${stdMatch[1].toLowerCase()}-${stdMatch[2]}`, isRecognized: true };
            return { id: nameNoExt.toLowerCase(), isRecognized: false };
        }
        function onWebThumbLoad(img) {
            const index = img.dataset.index;
            const file = loadedVideos[index];
            const fileId = img.dataset.fileid;
            if(!file || !fileId || isHistoryMode) return;
            try {
                const cvs = document.createElement('canvas');
                cvs.width = img.naturalWidth; cvs.height = img.naturalHeight;
                cvs.getContext('2d').drawImage(img, 0, 0);
                cvs.toBlob(blob => {
                    const currentTitle = titleCache[index] || "ì œëª© í™•ì¸ ì¤‘...";
                    addToHistory(file.name, currentTitle, fileId, file.webkitRelativePath, blob);
                }, 'image/jpeg', 0.8);
            } catch(e) {}
        }
        async function onThumbnailError(img) {
            const index = img.dataset.index;
            const file = loadedVideos[index];
            if (!file) return;

            // ì´ë¯¸ ì²˜ë¦¬ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
            if (img.dataset.processing) return;

            // ìƒíƒœ ì•„ì´ì½˜ í‘œì‹œ í•¨ìˆ˜
            const updateIcon = (status) => {
                let iconHtml = '';
                if (status === 'syncing') iconHtml = '<div class="cache-status-badge status-syncing">â³</div>';
                else if (status === 'completed') iconHtml = '<div class="cache-status-badge status-completed">âœ…</div>';
                
                // ê¸°ì¡´ ë°°ì§€ ì œê±° í›„ ì¶”ê°€
                const parent = img.parentElement;
                const old = parent.querySelector('.cache-status-badge');
                if(old) old.remove();
                if(iconHtml) parent.insertAdjacentHTML('beforeend', iconHtml);
            };

            if (db) {
                const key = getCacheKey(file);
                // 1. ì¸ë„¤ì¼ ìºì‹œ í™•ì¸
                const getReq = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).get(key);
                getReq.onsuccess = () => {
                    if (getReq.result) {
                        // ì¸ë„¤ì¼ì´ ìˆìœ¼ë©´ ë¡œë“œ
                        const url = URL.createObjectURL(getReq.result);
                        img.src = url; 
                        img.onload = () => URL.revokeObjectURL(url); 
                        img.onerror = null;
                        
                        // í´ë¦­ ì´ë²¤íŠ¸: í”„ë¦¬ë·° ì—´ê¸°
                        img.onclick = (e) => { e.stopPropagation(); openPreviewModal(index); };
                        
                        // 2. 4ë¶„í•  í”„ë¦¬ë·° ìºì‹œ í™•ì¸ (ë°±ê·¸ë¼ìš´ë“œ ì²´í¬)
                        const previewKey = key + "_preview";
                        const prevReq = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).get(previewKey);
                        prevReq.onsuccess = () => {
                            if(prevReq.result) updateIcon('completed'); // ì´ë¯¸ ìˆìŒ
                            else {
                                // ì¸ë„¤ì¼ì€ ìˆëŠ”ë° í”„ë¦¬ë·°ê°€ ì—†ìœ¼ë©´ ìë™ ìƒì„± ì‹œì‘
                                updateIcon('syncing');
                                generateFilmstrip(file, (blob) => {
                                    if(blob) {
                                        const tx = db.transaction(THUMB_STORE, 'readwrite');
                                        tx.objectStore(THUMB_STORE).put(blob, previewKey);
                                        updateIcon('completed');
                                    }
                                });
                            }
                        };

                        // íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ (ë©”íƒ€ë°ì´í„° í¬í•¨)
                        const fileId = img.dataset.fileid || "unknown";
                        addToHistory(file.name, titleCache[index], fileId, file.webkitRelativePath, getReq.result, {size: file.size, lastModified: file.lastModified});

                    } else { 
                        // DBì—ë„ ì—†ìœ¼ë©´ ìƒì„± í”„ë¡œì„¸ìŠ¤ ì§„ì…
                        tryNextFallback(img, updateIcon); 
                    }
                };
            } else { 
                tryNextFallback(img, updateIcon); 
            }
        }
        function tryNextFallback(img, statusCallback) {
            const fallbackUrl = img.dataset.fallback;
            const currentSrc = img.getAttribute('src');
            
            if (fallbackUrl && currentSrc !== fallbackUrl && !img.dataset.triedLocal) {
                // ì›¹ ì´ë¯¸ì§€ ì‹œë„
                img.src = fallbackUrl;
                // ... (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼: badge-no ì²˜ë¦¬ ë“±)
                const container = img.closest('.media-container');
                if(container && container.querySelector('.badge-no')) {
                    container.querySelector('.badge-no').style.display = 'none';
                }
                const currentClick = img.getAttribute('onclick');
                if (currentClick) {
                    const newClick = currentClick.replace('-uncensored-leak', '');
                    img.setAttribute('onclick', newClick);
                }
            } else {
                // ë¡œì»¬ ìƒì„± ì‹œë„
                img.onerror = null; 
                img.dataset.triedLocal = "true"; 
                img.style.opacity = "0.3";
                
                // ìƒì„± ì¤‘ ìƒíƒœ í‘œì‹œ
                if(statusCallback) statusCallback('syncing');
                img.dataset.processing = "true"; // ì²˜ë¦¬ ì¤‘ í”Œë˜ê·¸
                
                thumbObserver.observe(img);
            }
        }
        const thumbObserver = new IntersectionObserver((entries, obs) => {
            entries.forEach(e => {
                if (e.isIntersecting) { generateLocalThumbnail(e.target); obs.unobserve(e.target); }
            });
        }, { rootMargin: '200px' });
        async function generateLocalThumbnail(imgEl) {
            const index = imgEl.dataset.index;
            const file = loadedVideos[index];
            if (!file) return;

            const updateIcon = (status) => {
                const parent = imgEl.parentElement;
                const old = parent.querySelector('.cache-status-badge');
                if(old) old.remove();
                if(status === 'completed') parent.insertAdjacentHTML('beforeend', '<div class="cache-status-badge status-completed">âœ…</div>');
                else if(status === 'syncing') parent.insertAdjacentHTML('beforeend', '<div class="cache-status-badge status-syncing">â³</div>');
            };

            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true; video.playsInline = true; video.currentTime = 1; 
            
            const capture = () => {
                try {
                    const cvs = document.createElement('canvas');
                    const scale = 320 / video.videoWidth; 
                    cvs.width = 320; cvs.height = video.videoHeight * scale;
                    cvs.getContext('2d').drawImage(video, 0, 0, cvs.width, cvs.height);
                    
                    cvs.toBlob(blob => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            imgEl.src = url; 
                            imgEl.style.opacity = "1";
                            imgEl.onclick = (e) => { e.stopPropagation(); openPreviewModal(index); };

                            const fileId = imgEl.dataset.fileid || "unknown";
                            const fullPath = file.webkitRelativePath || file.name;

                            if(db) {
                                // 1. ì¸ë„¤ì¼ ì €ì¥
                                const tx = db.transaction(THUMB_STORE, 'readwrite');
                                tx.objectStore(THUMB_STORE).put(blob, getCacheKey(file));
                                tx.oncomplete = () => {
                                    updateCacheStatus(); // [ìˆ˜ì •] ì €ì¥ ì¦‰ì‹œ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                                };

                                // 2. íˆìŠ¤í† ë¦¬ ì €ì¥
                                addToHistory(file.name, titleCache[index], fileId, fullPath, blob, {size: file.size, lastModified: file.lastModified});
                            }

                            // 3. 4ë¶„í•  í”„ë¦¬ë·° ë°±ê·¸ë¼ìš´ë“œ ìƒì„±
                            generateFilmstrip(file, (stripBlob) => {
                                if(stripBlob && db) {
                                    const tx2 = db.transaction(THUMB_STORE, 'readwrite');
                                    tx2.objectStore(THUMB_STORE).put(stripBlob, getCacheKey(file) + "_preview");
                                    tx2.oncomplete = () => {
                                        updateIcon('completed');
                                        updateCacheStatus(); // [ìˆ˜ì •] í”„ë¦¬ë·° ì €ì¥ í›„ì—ë„ ê°œìˆ˜ ì—…ë°ì´íŠ¸
                                    };
                                }
                                URL.revokeObjectURL(video.src);
                                video.remove();
                            });
                            
                        } else {
                            URL.revokeObjectURL(video.src);
                            video.remove();
                        }
                    }, 'image/jpeg', 0.8);
                } catch (e) { URL.revokeObjectURL(video.src); }
            };

            video.onloadedmetadata = () => { if (video.duration) video.currentTime = video.duration * 0.5; };
            video.onseeked = capture; 
            video.onerror = () => URL.revokeObjectURL(video.src); 
            video.load();
        }
                // [ì‹ ê·œ] ë¡œì»¬ ì¸ë„¤ì¼ í´ë¦­ ì‹œ 4ë¶„í•  í”„ë¦¬ë·° í† ê¸€
        function openPreviewModal(index) {
            const file = loadedVideos[index];
            if (!file) return;

            const modal = document.getElementById('previewModal');
            const img = document.getElementById('previewImage');
            const loading = document.getElementById('previewLoading');

            // ì´ˆê¸°í™”
            img.style.display = 'none';
            img.src = '';
            loading.style.display = 'block';
            modal.style.display = 'flex';

            // DB ìºì‹œ í™•ì¸
            const previewKey = getCacheKey(file) + "_preview";
            
            const showImage = (blob) => {
                const url = URL.createObjectURL(blob);
                img.src = url;
                img.style.display = 'block';
                loading.style.display = 'none';
            };

            if (db) {
                const req = db.transaction(THUMB_STORE, 'readonly').objectStore(THUMB_STORE).get(previewKey);
                req.onsuccess = () => {
                    if (req.result) {
                        // ìºì‹œ ìˆìŒ
                        showImage(req.result);
                    } else {
                        // ìºì‹œ ì—†ìŒ -> ìƒì„±
                        generateFilmstrip(file, (blob) => {
                            if (blob) {
                                // DB ì €ì¥
                                const tx = db.transaction(THUMB_STORE, 'readwrite');
                                tx.objectStore(THUMB_STORE).put(blob, previewKey);
                                showImage(blob);
                            } else {
                                alert("ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì‹¤íŒ¨");
                                closePreviewModal();
                            }
                        });
                    }
                };
            } else {
                // DB ì—†ìŒ -> ê·¸ëƒ¥ ìƒì„±
                generateFilmstrip(file, showImage);
            }
        }

        function closePreviewModal() {
            const modal = document.getElementById('previewModal');
            const img = document.getElementById('previewImage');
            modal.style.display = 'none';
            img.src = ''; // ë©”ëª¨ë¦¬ í•´ì œ ë„ì›€
        }
        
        // [ì‹ ê·œ] 4ë¶„í•  ì„¸ë¡œ ì´ì–´ë¶™ì´ê¸° ì´ë¯¸ì§€ ìƒì„± (1/5, 2/5, 3/5, 4/5 ì§€ì )
        function generateFilmstrip(file, callback) {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;

            const frames = [];
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // ìº¡ì²˜í•  ì§€ì  (20%, 40%, 60%, 80%)
            const points = [0.2, 0.4, 0.6, 0.8];
            let step = 0;

            const processStep = () => {
                if (step >= points.length) {
                    // ëª¨ë“  í”„ë ˆì„ ìº¡ì²˜ ì™„ë£Œ -> í•©ì¹˜ê¸°
                    const w = 320; // ë„ˆë¹„ ê³ ì •
                    // ë¹„ìœ¨ ê³„ì‚° (ì²« í”„ë ˆì„ ê¸°ì¤€)
                    const scale = w / video.videoWidth;
                    const h = video.videoHeight * scale;
                    
                    canvas.width = w;
                    canvas.height = h * 4; // 4ì¥ ë†’ì´ í•©ì‚°

                    // ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                    frames.forEach((frameData, i) => {
                        ctx.drawImage(frameData, 0, i * h, w, h);
                    });

                    // Blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ì½œë°± ë°˜í™˜
                    canvas.toBlob((blob) => {
                        URL.revokeObjectURL(video.src);
                        video.remove();
                        callback(blob);
                    }, 'image/jpeg', 0.7);
                    return;
                }

                // ë‹¤ìŒ ì§€ì ìœ¼ë¡œ ì´ë™
                if (video.duration) {
                    video.currentTime = video.duration * points[step];
                } else {
                    // duration ì—†ëŠ” ê²½ìš°(ë§¤ìš° ë“œë¬¾) ëŒ€ë¹„
                    video.currentTime = 10 * (step + 1);
                }
            };

            video.onseeked = () => {
                // í˜„ì¬ í”„ë ˆì„ ì„ì‹œ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                const tempCvs = document.createElement('canvas');
                tempCvs.width = video.videoWidth;
                tempCvs.height = video.videoHeight;
                tempCvs.getContext('2d').drawImage(video, 0, 0);
                frames.push(tempCvs); // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥

                step++;
                processStep(); // ë‹¤ìŒ ë‹¨ê³„
            };

            video.onloadedmetadata = () => {
                processStep(); // ì²« ë‹¨ê³„ ì‹œì‘
            };

            video.onerror = () => {
                URL.revokeObjectURL(video.src);
                callback(null);
            };

            video.load();
        }

        // --- Player Logic (No Changes) ---
        const modal = document.getElementById('videoModal');
        const player = document.getElementById('mainPlayer');
        const playIcon = document.getElementById('playIcon');
        const seekBar = document.getElementById('seekBar');
        const videoWrapper = document.getElementById('videoWrapper');
        const videoTitleBar = document.getElementById('videoTitleBar');
        const gestureFeedback = document.getElementById('gestureFeedback');
        const subListModal = document.getElementById('subListModal');
        const subListContent = document.getElementById('subListContent');
        let isDraggingSeek = false; 
        let touchStartX = 0; 
        let touchStartTime = 0; 
        let isTouching = false; 
        let wasPlayingBeforeDrag = false; 
        const SENSITIVITY = 0.2; 
        let currentSubtitleKey = "";
        
        // [ì‹ ê·œ] í•€ì¹˜ ì¤Œ ê´€ë ¨ ë³€ìˆ˜ ì¶”ê°€
        let isPinching = false;
        let initialPinchDistance = 0;
        let lastScale = 1;
        let currentScale = 1;
        
        function clearSubtitles() {
            if (player.textTracks) for (let i = 0; i < player.textTracks.length; i++) player.textTracks[i].mode = 'disabled';
            player.querySelectorAll('track').forEach(t => t.remove());
            player.innerHTML = '';
        }
        function playLocalVideo(index) {
            const file = loadedVideos[index];
            if (!file) return;
            clearSubtitles(); 
            player.pause(); player.src = ""; player.load();
            const realTitle = titleCache[index];
            videoTitleBar.innerText = realTitle ? `${realTitle} (${file.name})` : file.name;
            player.src = URL.createObjectURL(file);
            player.playbackRate = 1.0;
            document.getElementById('speedBtnText').innerText = "1.0";
            document.getElementById('subStretchInput').value = ""; 
            subListContent.innerHTML = '<div style="color:#777; padding:10px;">ìë§‰ ì—†ìŒ</div>';
            const baseName = file.name.substring(0, file.name.lastIndexOf('.')).toLowerCase();
            if (subtitleMap[baseName]) readAndAttachSubtitle(subtitleMap[baseName], true);
            modal.style.display = 'flex'; player.controls = false; player.play().catch(() => {}); updatePlayIcon();
        }
        function readAndAttachSubtitle(file, isAuto = false) {
            currentSubtitleKey = file.name; const subDisplay = document.getElementById('customSubTitle'); subDisplay.innerHTML = '';
            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
                if (file.name.toLowerCase().endsWith('.srt') || file.name.toLowerCase().endsWith('.srn')) content = srtToVtt(content);
                const blob = new Blob([content], { type: 'text/vtt' });
                const subUrl = URL.createObjectURL(blob);
                const track = document.createElement('track');
                track.kind = 'subtitles'; track.label = 'Korean'; track.srclang = 'ko'; track.src = subUrl; track.default = true;
                track.onload = function() {
                    const cues = this.track.cues;
                    if (cues && cues.length > 0) {
                        for (let i = 0; i < cues.length; i++) {
                            if(!cues[i]._originalStartTime) { cues[i]._originalStartTime = cues[i].startTime; cues[i]._originalEndTime = cues[i].endTime; }
                            cues[i].line = -2; cues[i].snapToLines = true;
                        }
                    }
                    const savedFactor = loadSavedSubtitleFactor(currentSubtitleKey);
                    if (savedFactor) { applySubtitleFactor(savedFactor, false); if(!isAuto) alert(`ì €ì¥ëœ ìë§‰ ì†ë„ ì ìš©ë¨: ${(100/savedFactor).toFixed(2)}%`); }
                    renderSubList(cues); this.track.mode = 'hidden';
                    this.track.oncuechange = function() {
                        const activeCues = this.activeCues;
                        if (activeCues && activeCues.length > 0) subDisplay.innerHTML = activeCues[0].text.replace(/\n/g, '<br>'); else subDisplay.innerHTML = '';
                    };
                };
                player.appendChild(track);
                if(!isAuto && !localStorage.getItem('sub_factor_' + currentSubtitleKey)) { alert(`ìë§‰ ì ìš©ë¨: ${file.name}`); toggleMenu('subMenu'); }
            };
            reader.readAsText(file, 'UTF-8');
        }
        function loadSubtitleManual(input) { if (input.files && input.files[0]) readAndAttachSubtitle(input.files[0], false); }
        function closeModal() { 
            if (document.fullscreenElement) document.exitFullscreen(); 
            modal.style.display = 'none'; 
            player.pause(); 
            clearSubtitles(); 
            player.src = ""; 
            
            // [ì‹ ê·œ] ì¤Œ ì´ˆê¸°í™”
            currentScale = 1; 
            player.style.transform = 'scale(1)'; 
        }
        function toggleSubList() {
            const isVisible = subListModal.style.display === 'flex'; subListModal.style.display = isVisible ? 'none' : 'flex';
            if(!isVisible) {
                const cues = getCues();
                if(cues) {
                    for(let i=0; i<cues.length; i++) {
                        if(cues[i].startTime <= player.currentTime && cues[i].endTime >= player.currentTime) {
                            const item = document.getElementById(`sub-item-${i}`); if(item) item.scrollIntoView({block: 'center'}); break;
                        }
                    }
                }
            }
        }
        function renderSubList(cues) {
            if (!cues || cues.length === 0) return; let html = '';
            for (let i = 0; i < cues.length; i++) {
                const cue = cues[i]; const text = cue.text.replace(/<[^>]*>/g, '');
                html += `<div class="sub-item" id="sub-item-${i}" onclick="syncToSubtitleAsSpeed(${i})"><span class="sub-time">${formatTime(cue.startTime)}</span><span>${text}</span></div>`;
            }
            subListContent.innerHTML = html;
        }
        function syncToSubtitleAsSpeed(index) {
            const cues = getCues(); if (!cues || !cues[index]) return; const selectedCue = cues[index]; const originalStart = selectedCue._originalStartTime;
            if (!originalStart || originalStart <= 0) return alert("ì‹œì‘ ì‹œê°„ì´ 0ì¸ ìë§‰ìœ¼ë¡œëŠ” ì†ë„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            const factor = player.currentTime / originalStart; applySubtitleFactor(factor, true);
            document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active')); document.getElementById(`sub-item-${index}`).classList.add('active');
            alert(`ì†ë„ ë™ê¸°í™” ì™„ë£Œ!\në°°ìœ¨: ${factor.toFixed(4)}\n(ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤)`);
        }
        function applySubtitleStretchManual() {
            const val = document.getElementById('subStretchInput').value; if(!val) return; const percentage = parseFloat(val);
            if (percentage <= 0) return alert("0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤."); const factor = 100 / percentage; applySubtitleFactor(factor, true); alert(`ìˆ˜ë™ ì†ë„ ${percentage}% ì ìš© ì™„ë£Œ`);
        }
        function resetSubtitleFactor() { applySubtitleFactor(1.0, true); alert("ìë§‰ ì†ë„ ì´ˆê¸°í™” (100%)"); }
        function applySubtitleFactor(factor, save) {
            const cues = getCues(); if (!cues) return;
            for(let i=0; i<cues.length; i++){ 
                const cue = cues[i]; if(cue._originalStartTime !== undefined) { cue.startTime = cue._originalStartTime * factor; cue.endTime = cue._originalEndTime * factor; }
                cue.line = -2; cue.snapToLines = true; if(i > 0) { const prevCue = cues[i-1]; if(prevCue.endTime > cue.startTime) prevCue.endTime = cue.startTime; }
            }
            if(save && currentSubtitleKey) localStorage.setItem('sub_factor_' + currentSubtitleKey, factor);
        }
        function loadSavedSubtitleFactor(key) { const val = localStorage.getItem('sub_factor_' + key); return val ? parseFloat(val) : null; }
        function getCues() { const tracks = Array.from(player.textTracks).filter(t => t.mode === 'showing'); return (tracks.length > 0) ? tracks[0].cues : null; }
        function formatTime(seconds) { const m = Math.floor(seconds / 60); const s = Math.floor(seconds % 60); return `${m}:${s < 10 ? '0' : ''}${s}`; }
        player.addEventListener('loadedmetadata', () => { document.getElementById('durationText').innerText = formatTime(player.duration); seekBar.max = player.duration; });
        player.addEventListener('timeupdate', () => {
            if (!isDraggingSeek && !isTouching) { 
                seekBar.value = player.currentTime; document.getElementById('currentTimeText').innerText = formatTime(player.currentTime);
                const cues = getCues();
                if(cues && subListModal.style.display === 'flex') {
                    for(let i=0; i<cues.length; i++) {
                        if(cues[i].startTime <= player.currentTime && cues[i].endTime >= player.currentTime) {
                            document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active')); const activeItem = document.getElementById(`sub-item-${i}`); if(activeItem) activeItem.classList.add('active'); break;
                        }
                    }
                }
            }
        });
        seekBar.addEventListener('input', () => { isDraggingSeek = true; const val = parseFloat(seekBar.value); document.getElementById('currentTimeText').innerText = formatTime(val); if(!player.seeking) player.currentTime = val; });
        seekBar.addEventListener('change', () => { isDraggingSeek = false; player.currentTime = seekBar.value; });
        let longPressTimer = null; let savedSpeed = 1.0; let isSpeeding = false;
        videoWrapper.addEventListener('contextmenu', (e) => { e.preventDefault(); return false; });
        videoWrapper.addEventListener('touchstart', onGestureStart, {passive: false}); videoWrapper.addEventListener('touchmove', onGestureMove, {passive: false}); videoWrapper.addEventListener('touchend', onGestureEnd);
        videoWrapper.addEventListener('mousedown', onGestureStart); videoWrapper.addEventListener('mousemove', onGestureMove); videoWrapper.addEventListener('mouseup', onGestureEnd); videoWrapper.addEventListener('mouseleave', onGestureEnd); 

        function onGestureStart(e) {
            if(e.target.closest('.controls-bar') || e.target.closest('.popup-menu') || e.target.closest('.sub-list-modal') || e.target.tagName === 'BUTTON') return;
            
            // [ì‹ ê·œ] 2ì†ê°€ë½ í„°ì¹˜ ì‹œ í•€ì¹˜ ì¤Œ ì‹œì‘
            if (e.touches && e.touches.length === 2) {
                isPinching = true;
                // ë‘ ì†ê°€ë½ ì‚¬ì´ì˜ ê±°ë¦¬ ê³„ì‚°
                initialPinchDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                lastScale = currentScale; // í˜„ì¬ ìŠ¤ì¼€ì¼ ê¸°ì–µ
                return; // íƒìƒ‰/ë°°ì† ë¡œì§ ì‹¤í–‰ ë°©ì§€
            }
        
            isTouching = true; 
            isSpeeding = false; 
            wasPlayingBeforeDrag = !player.paused; 
            
            // 1ì†ê°€ë½ í„°ì¹˜ ì¢Œí‘œ
            touchStartX = (e.type === 'touchstart' ? e.touches[0].clientX : e.clientX); 
            touchStartTime = player.currentTime;
            
            if (wasPlayingBeforeDrag) {
                longPressTimer = setTimeout(() => {
                    if (isTouching && !isDraggingSeek && !isPinching) { // í•€ì¹˜ ì¤‘ ì•„ë‹ ë•Œë§Œ
                        isSpeeding = true; 
                        savedSpeed = player.playbackRate; 
                        player.playbackRate = 4.0; 
                        
                        gestureFeedback.style.top = '60px'; 
                        gestureFeedback.style.left = '20px';
                        gestureFeedback.style.transform = 'none'; 
                        
                        gestureFeedback.style.opacity = '1'; 
                        gestureFeedback.innerText = 'â© 4.0x'; 
                    }
                }, 300);
            }
        }
        
        function onGestureMove(e) {
            // [ì‹ ê·œ] í•€ì¹˜ ì¤Œ ë¡œì§
            if (isPinching && e.touches && e.touches.length === 2) {
                if(e.cancelable) e.preventDefault(); // í™”ë©´ ìŠ¤í¬ë¡¤ ë°©ì§€
        
                const currentDist = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
        
                if (initialPinchDistance > 0) {
                    const zoomFactor = currentDist / initialPinchDistance;
                    // ì¤Œ ë²”ìœ„ ì œí•œ (1.0ë°° ~ 5.0ë°°)
                    let newScale = lastScale * zoomFactor;
                    newScale = Math.min(Math.max(newScale, 1.0), 5.0);
                    
                    currentScale = newScale;
                    player.style.transform = `scale(${currentScale})`;
                    
                    // ì¤Œ ìƒíƒœ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
                    gestureFeedback.style.top = '50%';
                    gestureFeedback.style.left = '50%';
                    gestureFeedback.style.transform = 'translate(-50%, -50%)';
                    gestureFeedback.style.opacity = '1';
                    gestureFeedback.innerText = `ğŸ” ${currentScale.toFixed(1)}x`;
                }
                return;
            }
        
            if (!isTouching || isPinching) return; // í•€ì¹˜ ì¤‘ì´ë©´ íƒìƒ‰ ì•ˆ í•¨
            
            if (isSpeeding) return;
        
            if(e.cancelable) e.preventDefault(); 
            
            const currentX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX); 
            const diffX = currentX - touchStartX;
            
            if (Math.abs(diffX) > 5) {
                clearTimeout(longPressTimer);
                
                if (isSpeeding) { 
                    isSpeeding = false; 
                    player.playbackRate = savedSpeed; 
                    gestureFeedback.style.opacity = '0'; 
                }
        
                if (wasPlayingBeforeDrag && !player.paused) player.pause();
                
                const timeDiff = diffX * SENSITIVITY; 
                let targetTime = touchStartTime + timeDiff;
                if (targetTime < 0) targetTime = 0; 
                if (targetTime > player.duration) targetTime = player.duration;
                
                seekBar.value = targetTime; 
                document.getElementById('currentTimeText').innerText = formatTime(targetTime); 
                
                gestureFeedback.style.top = '50%';
                gestureFeedback.style.left = '50%';
                gestureFeedback.style.transform = 'translate(-50%, -50%)';
                
                gestureFeedback.style.opacity = '1'; 
                gestureFeedback.innerText = formatTime(targetTime);
                
                if (!player.seeking) player.currentTime = targetTime;
            }
        }
        
        function onGestureEnd(e) {
            clearTimeout(longPressTimer);
        
            // [ì‹ ê·œ] í•€ì¹˜ ì¢…ë£Œ ì²˜ë¦¬
            if (isPinching) {
                // ì†ê°€ë½ì„ ëª¨ë‘ ë–¼ë©´ í•€ì¹˜ ì¢…ë£Œë¡œ ê°„ì£¼
                if (!e.touches || e.touches.length === 0) {
                    isPinching = false;
                    gestureFeedback.style.opacity = '0';
                }
                return;
            }
        
            if (isTouching) { 
                isTouching = false; 
                
                if (isSpeeding) { 
                    player.playbackRate = savedSpeed; 
                    isSpeeding = false; 
                    gestureFeedback.style.opacity = '0'; 
                } else { 
                    gestureFeedback.style.opacity = '0'; 
                    if(wasPlayingBeforeDrag) player.play(); 
                }
                
                setTimeout(() => {
                    gestureFeedback.style.top = '50%';
                    gestureFeedback.style.left = '50%';
                    gestureFeedback.style.transform = 'translate(-50%, -50%)';
                }, 200);
            }
        }
        
        function toggleControls() {
            const bar = document.getElementById('controlsBar'); const titleBar = document.getElementById('videoTitleBar');
            if (bar.style.opacity === '0') { bar.style.opacity = '1'; bar.style.pointerEvents = 'auto'; titleBar.style.opacity = '1'; }
            else { bar.style.opacity = '0'; bar.style.pointerEvents = 'none'; titleBar.style.opacity = '0'; document.querySelectorAll('.popup-menu').forEach(el => el.style.display = 'none'); }
        }
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId); const isVisible = menu.style.display === 'flex';
            document.querySelectorAll('.popup-menu').forEach(el => el.style.display = 'none'); subListModal.style.display = 'none'; if (!isVisible) menu.style.display = 'flex';
        }
        function togglePlay() { if (player.paused) player.play(); else player.pause(); updatePlayIcon(); }
        player.addEventListener('play', updatePlayIcon); player.addEventListener('pause', updatePlayIcon);
        function updatePlayIcon() { playIcon.innerText = player.paused ? "â–¶" : "â¸"; }
        function seek(sec) { player.currentTime += sec; }
        function setSpeed(rate) { player.playbackRate = rate; document.getElementById('speedBtnText').innerText = rate; toggleMenu('speedMenu'); }
        function toggleFullscreen() { if (!document.fullscreenElement) videoWrapper.requestFullscreen().catch(() => {}); else document.exitFullscreen(); }
        function srtToVtt(srt) { return "WEBVTT\n\n" + srt.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4'); }
        // === [ì¶”ê°€] ì›¹ í”„ë¦¬ë·° ì¬ìƒ í•¨ìˆ˜ ===
        function playWebPreview(divId, videoUrl, targetLink) {
            const container = document.getElementById(divId);
            if (!container) return;

            // ì´ë¯¸ ë¹„ë””ì˜¤ê°€ ì¬ìƒ ì¤‘ì´ë¼ë©´ í´ë¦­ ì‹œ í•´ë‹¹ ì‚¬ì´íŠ¸(MissAV)ë¡œ ì´ë™
            if (container.querySelector('video')) {
                window.open(targetLink, '_blank');
                return;
            }

            // ê¸°ì¡´ ì´ë¯¸ì§€ HTML ë°±ì—… (ì—ëŸ¬ ì‹œ ë³µêµ¬ìš©)
            const originalContent = container.innerHTML;

            // ë¹„ë””ì˜¤ íƒœê·¸ ìƒì„±
            const video = document.createElement('video');
            video.src = videoUrl;
            video.autoplay = true;
            video.muted = true; // ë¸Œë¼ìš°ì € ì •ì±…ìƒ ìë™ì¬ìƒì„ ìœ„í•´ ìŒì†Œê±° í•„ìˆ˜
            video.loop = true;
            video.playsInline = true;
            video.className = 'media-content'; // CSS ìŠ¤íƒ€ì¼ ìƒì† (ê½‰ ì°¨ê²Œ í‘œì‹œ)
            
            // ë¡œë”© ì¤‘ì„ì„ í‘œì‹œí•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ (ì„ íƒì‚¬í•­)
            // container.style.opacity = 0.5;

            // ì˜ìƒ ë¡œë“œ ì„±ê³µ ì‹œ
            video.onloadeddata = () => {
                // container.style.opacity = 1;
            };

            // ì˜ìƒì´ ì—†ê±°ë‚˜ ì—ëŸ¬ ë°œìƒ ì‹œ ì›ë˜ ì´ë¯¸ì§€ë¡œ ë³µêµ¬
            video.onerror = () => {
                container.innerHTML = originalContent;
                // ì„ íƒì‚¬í•­: í”„ë¦¬ë·°ê°€ ì—†ìœ¼ë©´ ë°”ë¡œ ìƒˆì°½ì„ ë„ìš°ë ¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // window.open(targetLink, '_blank');
            };

            // ë¹„ë””ì˜¤ í´ë¦­ ì‹œ ì‚¬ì´íŠ¸ ì´ë™ ì´ë²¤íŠ¸ ì—°ê²°
            video.onclick = (e) => {
                e.stopPropagation();
                window.open(targetLink, '_blank');
            };

            // ì»¨í…Œì´ë„ˆ ë‚´ìš©ì„ ë¹„ë””ì˜¤ë¡œ êµì²´
            container.innerHTML = '';
            container.appendChild(video);
        }
    </script>
</body>
</html>
