<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JAV Folder Player (Smart Scan Support)</title>
    <style>
        /* === ê¸°ë³¸ ìŠ¤íƒ€ì¼ === */
        body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; margin: 0; padding: 10px; padding-bottom: 50px; }
        * { box-sizing: border-box; }
        a { text-decoration: none; color: inherit; }

        /* ìë§‰ ìŠ¤íƒ€ì¼ */
        video::cue {
            background-color: rgba(0, 0, 0, 0.75);
            color: #fff;
            font-size: 1.1rem;
            line-height: 1.2;
            text-shadow: 1px 1px 2px #000;
        }

        /* === 1. ì»¨íŠ¸ë¡¤ íŒ¨ë„ === */
        .control-panel {
            text-align: center; margin-bottom: 20px; padding: 15px;
            background-color: #1e1e1e; border-radius: 8px; border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .custom-file-upload {
            display: inline-block; padding: 12px 25px; cursor: pointer;
            background-color: #0d6efd; color: white; border-radius: 6px;
            font-weight: bold; font-size: 1rem; transition: background 0.2s;
        }
        .custom-file-upload:hover { background-color: #0b5ed7; }
        input[type="file"] { display: none; }
        .status-msg { margin-top: 10px; color: #aaa; font-size: 0.9rem; }

        /* === 2. ê·¸ë¦¬ë“œ ë¦¬ìŠ¤íŠ¸ === */
        .container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
            max-width: 1200px; margin: 0 auto;
        }
        .item {
            background-color: #1e1e1e; border-radius: 6px; overflow: hidden;
            padding: 8px; text-align: center; position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid #333;
            display: flex; flex-direction: column; min-height: 220px;
        }
        .filename {
            font-size: 0.9rem; font-weight: bold; margin-bottom: 4px; color: #fff;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block;
        }
        .video-title {
            font-size: 0.75rem; color: #bbb; margin-bottom: 8px; min-height: 2.4rem;
            line-height: 1.2; word-break: break-all;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
        }
        .media-container {
            position: relative; width: 100%; padding-top: 66.66%;
            background-color: #000; border-radius: 4px; overflow: hidden; margin-bottom: 8px;
            cursor: pointer;
        }
        .media-content {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;
        }
        .badge-no {
            position: absolute; top: 5px; left: 5px; width: 24px; height: 24px;
            background-color: #ffc107; color: #000; border-radius: 50%;
            font-weight: bold; font-size: 0.8rem; display: flex; align-items: center; justify-content: center;
            z-index: 10; pointer-events: none;
        }
        .btn-group { display: flex; gap: 4px; margin-top: auto; }
        .action-btn {
            flex: 1; padding: 10px 0; border: none; border-radius: 4px;
            font-size: 0.85rem; font-weight: bold; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-play-local { background-color: #198754; }
        .btn-info { background-color: #6c757d; }

        /* === 3. í”Œë ˆì´ì–´ ëª¨ë‹¬ === */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 2000;
        }
        .video-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center; background: #000;
        }
        video { width: 100%; max-height: 100vh; outline: none; }

        .video-title-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px 60px 15px 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            color: #fff; font-size: 1rem; font-weight: bold;
            z-index: 2100; pointer-events: none;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .gesture-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.6); color: white; padding: 15px 25px; border-radius: 30px;
            font-size: 1.5rem; font-weight: bold; pointer-events: none; opacity: 0; transition: opacity 0.2s; z-index: 2050;
        }

        .controls-bar {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), rgba(0,0,0,0));
            padding: 10px 15px 25px 15px;
            display: flex; flex-direction: column; gap: 10px; z-index: 2100;
        }

        .progress-container { width: 100%; display: flex; align-items: center; gap: 10px; }
        .progress-time { font-size: 0.8rem; color: #ddd; min-width: 45px; text-align: center; }
        input[type=range] { flex-grow: 1; -webkit-appearance: none; background: rgba(255,255,255,0.2); height: 4px; border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: #0d6efd; border-radius: 50%; cursor: pointer; }

        .ctrl-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .ctrl-group { display: flex; align-items: center; gap: 10px; }
        .ctrl-btn { background: none; border: none; color: #fff; font-size: 1.4rem; cursor: pointer; padding: 5px; }
        .small-text { font-size: 0.8rem; margin-left: 2px; font-weight: normal; }

        .top-close-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.3);
            border-radius: 50%; width: 36px; height: 36px;
            font-size: 1.2rem; cursor: pointer; z-index: 2200;
            display: flex; align-items: center; justify-content: center;
        }

        /* íŒì—… ë©”ë‰´ */
        .popup-menu {
            position: absolute; bottom: 80px; 
            background-color: rgba(28, 28, 28, 0.95);
            border: 1px solid #444; border-radius: 8px;
            padding: 12px; width: 280px;
            display: none; flex-direction: column; gap: 8px; z-index: 2200;
        }
        #speedMenu { left: 15px; }
        #subMenu { right: 15px; }
        .menu-title { font-size: 0.9rem; color: #aaa; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; }
        .menu-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .menu-btn { background: #333; border: 1px solid #555; color: #eee; padding: 6px 10px; border-radius: 4px; font-size: 0.85rem; cursor: pointer; }
        .menu-input { width: 60px; background: #222; border: 1px solid #555; color: #fff; padding: 4px; text-align: center; border-radius: 4px; }

        /* ìë§‰ ë¦¬ìŠ¤íŠ¸ ëª¨ë‹¬ */
        .sub-list-modal {
            position: absolute; top: 0; right: 0; width: 300px; height: 100%;
            background: rgba(20, 20, 20, 0.95); border-left: 1px solid #444;
            z-index: 2300; display: none; flex-direction: column;
            padding: 10px;
        }
        .sub-list-header {
            font-size: 1rem; font-weight: bold; color: #fff; border-bottom: 1px solid #555;
            padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between;
        }
        .sub-list-content {
            flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px;
        }
        .sub-item {
            padding: 8px; background: #333; border-radius: 4px; color: #ccc; font-size: 0.85rem; cursor: pointer;
            transition: background 0.2s;
        }
        .sub-item:hover { background: #444; color: #fff; }
        .sub-item.active { border-left: 4px solid #0d6efd; background: #2a2a2a; color: #fff; font-weight: bold; }
        .sub-time { font-size: 0.75rem; color: #888; display: block; margin-bottom: 2px; }
        .guide-text { font-size: 0.75rem; color: #bbb; padding: 0 5px 10px 5px; line-height: 1.3; }
    </style>
</head>
<body>

    <div class="control-panel">
        <label for="folder-upload" class="custom-file-upload">
            ğŸ“‚ í´ë” ì„ íƒ (Select Folder)
        </label>
        <input id="folder-upload" type="file" webkitdirectory directory multiple />
        <div id="status" class="status-msg">í´ë”ë¥¼ ì„ íƒí•˜ë©´ ì˜ìƒ ëª©ë¡ì„ ìŠ¤ìº”í•©ë‹ˆë‹¤.</div>
    </div>

    <div id="gallery" class="container"></div>

    <div id="videoModal" class="modal-overlay">
        <div id="videoWrapper" class="video-wrapper">
            <div id="videoTitleBar" class="video-title-bar"></div>
            <div id="gestureFeedback" class="gesture-overlay">00:00</div>
            
            <video id="mainPlayer" playsinline onclick="toggleControls()" crossorigin="anonymous"></video>
            <button class="top-close-btn" onclick="closeModal()">âœ•</button>

            <!-- ìë§‰ ë¦¬ìŠ¤íŠ¸ (ì†ë„ ì‹±í¬ìš©) -->
            <div id="subListModal" class="sub-list-modal" onclick="event.stopPropagation()">
                <div class="sub-list-header">
                    <span>ğŸ“‘ ìë§‰ ì†ë„ ë§ì¶¤ (Speed Sync)</span>
                    <button onclick="toggleSubList()" style="background:none; border:none; color:#fff; cursor:pointer;">âœ•</button>
                </div>
                <div class="guide-text">
                    * ì˜ìƒì—ì„œ ë“¤ë¦¬ëŠ” ëŒ€ì‚¬ë¥¼ í´ë¦­í•˜ì„¸ìš”.<br>
                    * í•´ë‹¹ ëŒ€ì‚¬ê°€ í˜„ì¬ ì‹œê°„ì— ì˜¤ë„ë¡ <strong>ì „ì²´ ìë§‰ ì†ë„</strong>ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì ˆí•˜ê³  ì €ì¥í•©ë‹ˆë‹¤.
                </div>
                <div id="subListContent" class="sub-list-content">
                    <div style="color:#777; font-size:0.8rem; padding:10px;">ìë§‰ ì—†ìŒ</div>
                </div>
            </div>

            <div id="controlsBar" class="controls-bar">
                <div class="progress-container">
                    <span id="currentTimeText" class="progress-time">0:00</span>
                    <input type="range" id="seekBar" value="0" step="0.1" min="0">
                    <span id="durationText" class="progress-time">0:00</span>
                </div>

                <div class="ctrl-row">
                    <div class="ctrl-group">
                        <button class="ctrl-btn" onclick="togglePlay()" id="playIcon">â–¶</button>
                        <button class="ctrl-btn" style="font-size:1.1rem" onclick="seek(-10)">âª</button>
                        <button class="ctrl-btn" style="font-size:1.1rem" onclick="seek(10)">â©</button>
                        <button class="ctrl-btn" onclick="toggleMenu('speedMenu')">âš¡<span id="speedBtnText" class="small-text">1.0</span></button>
                    </div>
                    <div class="ctrl-group">
                        <button class="ctrl-btn" onclick="toggleSubList()" title="ìë§‰ ë¦¬ìŠ¤íŠ¸ & ì†ë„ ì‹±í¬">ğŸ“‘</button>
                        <button class="ctrl-btn" onclick="toggleMenu('subMenu')">ğŸ’¬</button>
                        <button class="ctrl-btn" onclick="toggleFullscreen()">â›¶</button>
                    </div>
                </div>
            </div>

            <div id="speedMenu" class="popup-menu" onclick="event.stopPropagation()">
                <div class="menu-title">ì˜ìƒ ì¬ìƒ ì†ë„</div>
                <div class="menu-row">
                    <button class="menu-btn" onclick="setSpeed(1.0)">1.0x</button>
                    <button class="menu-btn" onclick="setSpeed(1.2)">1.2x</button>
                    <button class="menu-btn" onclick="setSpeed(1.5)">1.5x</button>
                    <button class="menu-btn" onclick="setSpeed(2.0)">2.0x</button>
                </div>
            </div>

            <div id="subMenu" class="popup-menu" onclick="event.stopPropagation()">
                <div class="menu-title">ìë§‰ ì†ë„ (Stretch) ìˆ˜ë™ ì…ë ¥</div>
                <div class="menu-row">
                    <input type="number" id="subStretchInput" class="menu-input" placeholder="98.55">
                    <span style="font-size:0.8rem">%</span>
                    <button class="menu-btn" onclick="applySubtitleStretchManual()">ì ìš©</button>
                </div>
                <div style="margin-top:5px;">
                    <button class="menu-btn" style="width:100%" onclick="resetSubtitleFactor()">â†º ì†ë„ ì´ˆê¸°í™” (100%)</button>
                </div>
                
                <div class="menu-title" style="margin-top:8px;">ìë§‰ íŒŒì¼ ì—´ê¸°</div>
                <div class="menu-row">
                    <input id="sub-upload" type="file" accept=".srt, .vtt" onchange="loadSubtitleManual(this)" style="display:none;" />
                    <label for="sub-upload" class="menu-btn" style="width:100%; text-align:center; background:#444;">ğŸ“‚ ìë§‰ ì„ íƒ</label>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === ì „ì—­ ë³€ìˆ˜ ===
        let loadedVideos = [];
        let subtitleMap = {};
        let titleCache = {};
        let titleQueue = [];
        let isBatchRunning = false;
        const BATCH_SIZE = 20;
        const BATCH_DELAY = 500;
        const MAX_RETRIES = 2;

        const player = document.getElementById('mainPlayer');
        const playIcon = document.getElementById('playIcon');
        const seekBar = document.getElementById('seekBar');
        const videoWrapper = document.getElementById('videoWrapper');
        const videoTitleBar = document.getElementById('videoTitleBar');
        const gestureFeedback = document.getElementById('gestureFeedback');
        const subListModal = document.getElementById('subListModal');
        const subListContent = document.getElementById('subListContent');

        let isDraggingSeek = false;
        let touchStartX = 0; let touchStartTime = 0; let isTouching = false; let wasPlayingBeforeDrag = false; 
        const SENSITIVITY = 0.2; 

        // [New] í˜„ì¬ ì¬ìƒì¤‘ì¸ ìë§‰ íŒŒì¼ ì‹ë³„ì (ì €ì¥ìš©)
        let currentSubtitleKey = ""; 

        // ==========================================
        // 1. íŒŒì¼ ìŠ¤ìº” (ê²€ìƒ‰ ë¡œì§ ê°•í™” ì ìš©)
        // ==========================================
        document.getElementById('folder-upload').addEventListener('change', function(event) {
            const files = Array.from(event.target.files);
            const gallery = document.getElementById('gallery');
            const status = document.getElementById('status');
            
            loadedVideos = [];
            subtitleMap = {};
            titleQueue = [];
            titleCache = {};

            files.forEach(f => {
                const nameLower = f.name.toLowerCase();
                if (f.type.startsWith('video/') || nameLower.match(/\.(mp4|avi|mkv|wmv|mov|webm|m4v|nel)$/)) {
                    loadedVideos.push(f);
                } 
                else if (nameLower.endsWith('.srt') || nameLower.endsWith('.vtt')) {
                    const baseName = nameLower.substring(0, nameLower.lastIndexOf('.'));
                    subtitleMap[baseName] = f;
                }
            });

            if (loadedVideos.length === 0) {
                status.innerText = "ë™ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.";
                return;
            }
            loadedVideos.sort((a, b) => a.name.localeCompare(b.name, undefined, {numeric: true, sensitivity: 'base'}));
            status.innerText = `ë™ì˜ìƒ ${loadedVideos.length}ê°œ, ìë§‰ ${Object.keys(subtitleMap).length}ê°œ ìŠ¤ìº” ì™„ë£Œ.`;
            gallery.innerHTML = '';

            loadedVideos.forEach((file, index) => {
                // í™•ì¥ì ì œì™¸í•œ íŒŒì¼ëª…
                const nameNoExt = file.name.substring(0, file.name.lastIndexOf('.'));
                
                let fileId = "";
                let isRecognized = false;

                // [ìˆ˜ì •ë¨: ë‹¤ì–‘í•œ í’ˆë²ˆ í¬ë§· ê°ì§€ ë¡œì§]
                
                // 1. FC2 (fc2-ppv-123, fc2 123 ë“±)
                const fc2Match = nameNoExt.match(/fc2[-\s\.]?(?:ppv)?[-\s\.]?(\d+)/i);
                
                // 2. Caribbeancom (carib-010123-001)
                const caribMatch = nameNoExt.match(/carib(?:beancom)?[-\s\.]?(\d{6})[-\s\.]?(\d{3})/i);

                // [NEW] 3. íŠ¹ìˆ˜ ë‚ ì§œ í¬ë§· (6ìë¦¬ ìˆ«ì + (_ ë˜ëŠ” -) + 2~3ìë¦¬ ìˆ«ì)
                // ì˜ˆ: 031417_498, 011018-01, 011018-002, 012528_637
                // íŒŒì¼ëª… ì¤‘ê°„ì— í¬í•¨ë˜ì–´ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì•ë’¤ë¡œ êµ¬ë¶„ì ì²´í¬ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‚˜,
                // ì—¬ê¸°ì„œëŠ” ê°€ì¥ ëª…í™•í•œ íŒ¨í„´ì„ ìš°ì„  ë§¤ì¹­í•©ë‹ˆë‹¤.
                const mixedDateMatch = nameNoExt.match(/(\d{6})([-_])(\d{2,3})/);

                // 4. ì¼ë°˜ ë‚ ì§œí˜• (041912-998) - ê¸°ì¡´ ë¡œì§ ìœ ì§€
                const dateMatch = nameNoExt.match(/(\d{6})[-\s\.]?(\d{3,})/);
                
                // 5. Tokyo Hot (n0594)
                const nMatch = nameNoExt.match(/n(\d{3,5})/i);
                
                // 6. ì¼ë°˜ í’ˆë²ˆ (ë¬¸ì+ìˆ«ì)
                const stdMatch = nameNoExt.match(/([a-z]+)[-\s\.]?(\d+)/i);

                if (fc2Match) {
                    fileId = `fc2-ppv-${fc2Match[1]}`;
                    isRecognized = true;
                } 
                else if (caribMatch) {
                    fileId = `caribbeancom-${caribMatch[1]}-${caribMatch[2]}`;
                    isRecognized = true;
                }
                else if (mixedDateMatch) {
                    // [NEW] ì‚¬ìš©ìê°€ ìš”ì²­í•œ í¬ë§·: êµ¬ë¶„ìì™€ ìˆ«ìë¥¼ ê·¸ëŒ€ë¡œ ìœ ì§€
                    // 031417_498 -> 031417_498
                    // 011018-01  -> 011018-01
                    fileId = `${mixedDateMatch[1]}${mixedDateMatch[2]}${mixedDateMatch[3]}`;
                    isRecognized = true;
                }
                else if (dateMatch) {
                    fileId = `${dateMatch[1]}-${dateMatch[2]}`;
                    isRecognized = true;
                }
                else if (nMatch) {
                    fileId = `n${nMatch[1]}`;
                    isRecognized = true;
                }
                else if (stdMatch) {
                    fileId = `${stdMatch[1].toLowerCase()}-${stdMatch[2]}`;
                    isRecognized = true;
                } 
                else {
                    // ê°ì§€ ì‹¤íŒ¨ ì‹œ ì›ë³¸ íŒŒì¼ëª…(ì†Œë¬¸ì) ì‚¬ìš©
                    fileId = nameNoExt.toLowerCase();
                    isRecognized = false;
                }

                const uncensoredId = fileId + "-uncensored-leak";
                const uncThumb = `https://wsrv.nl/?url=fourhoi.com/${uncensoredId}/cover-t.jpg&q=70`;
                const uncPrev = `https://fourhoi.com/${uncensoredId}/preview.mp4`;
                const stdThumb = `https://wsrv.nl/?url=fourhoi.com/${fileId}/cover-t.jpg&q=70`;
                const stdPrev = `https://fourhoi.com/${fileId}/preview.mp4`;
                const targetUrl = `https://missav.live/ko/${fileId}`;
                const divId = `media-${index}`;

                const itemHtml = `
                    <div class="item">
                        <div class="filename">${file.name}</div>
                        <div class="video-title" id="title-${index}">...</div>
                        <div id="${divId}" class="media-container">
                            <div class="badge-no">ë…¸</div>
                            <img src="${uncThumb}" class="media-content"
                                onclick="playWebPreview('${divId}', '${uncPrev}', '${targetUrl}')"
                                onerror="this.src='${stdThumb}'; this.parentNode.querySelector('.badge-no').style.display='none'; this.setAttribute('onclick', 'playWebPreview(\\'${divId}\\', \\'${stdPrev}\\', \\'${targetUrl}\\')');"
                            >
                        </div>
                        <div class="btn-group">
                            <button class="action-btn btn-play-local" onclick="playLocalVideo(${index})">â–¶ ì¬ìƒ</button>
                            <button class="action-btn btn-info" onclick="window.open('${targetUrl}', '_blank')">ğŸ”— ì •ë³´</button>
                        </div>
                    </div>
                `;
                gallery.insertAdjacentHTML('beforeend', itemHtml);
                
                if (isRecognized) {
                    addToQueue(fileId, index);
                } else {
                    document.getElementById(`title-${index}`).innerText = "ID ì¶”ì¶œ ì‹¤íŒ¨";
                }
            });
        });

        // ì œëª© ê°€ì ¸ì˜¤ê¸°
        function addToQueue(fileId, index) { titleQueue.push({ id: fileId, index: index, retries: 0 }); processBatch(); }
        async function processBatch() {
            if (isBatchRunning || titleQueue.length === 0) return;
            isBatchRunning = true;
            const batch = titleQueue.splice(0, BATCH_SIZE);
            const promises = batch.map(item => fetchTitleMissAV(item));
            await Promise.allSettled(promises);
            setTimeout(() => { isBatchRunning = false; processBatch(); }, BATCH_DELAY);
        }
        async function fetchTitleMissAV(item) {
            const titleEl = document.getElementById(`title-${item.index}`);
            if(!titleEl) return;
            if (item.retries === 0) titleEl.innerText = "í™•ì¸ ì¤‘...";
            const proxyUrl = `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(`https://missavtv.com/ko/${item.id}`)}`;
            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error("Net");
                const htmlText = await response.text();
                const match = htmlText.match(/<title>(.*?)<\/title>/i);
                if (match && match[1]) {
                    let fullTitle = match[1].replace(" | MissAV", "").replace("ë¬´ë£Œ ìŠ¤íŠ¸ë¦¬ë°", "").replace("Online", "");
                    let cleanTitle = fullTitle.replace(new RegExp(item.id, 'gi'), '').trim().replace(/^[-â€“\s]+/, '');
                    if (cleanTitle && cleanTitle.length > 1) {
                        titleEl.innerText = cleanTitle; titleEl.style.color = "#fff";
                        titleCache[item.index] = cleanTitle; return;
                    }
                }
                throw new Error("Parse Fail");
            } catch (e) {
                item.retries++;
                if (item.retries < MAX_RETRIES) titleQueue.push(item);
                else titleEl.innerText = "";
            }
        }
        function playWebPreview(divId, vUrl, tUrl) {
            const container = document.getElementById(divId);
            const badge = container.querySelector('.badge-no');
            if(badge) badge.style.display = 'none';
            container.innerHTML = `<video src="${vUrl}" autoplay loop muted playsinline class="media-content" onclick="window.open('${tUrl}', '_blank');"></video>`;
        }


        // ==========================================
        // 3. ë¡œì»¬ í”Œë ˆì´ì–´
        // ==========================================
        const modal = document.getElementById('videoModal');

        function clearSubtitles() {
            if (player.textTracks) for (let i = 0; i < player.textTracks.length; i++) player.textTracks[i].mode = 'disabled';
            player.querySelectorAll('track').forEach(t => t.remove());
            player.innerHTML = '';
        }

        function playLocalVideo(index) {
            const file = loadedVideos[index];
            if (!file) return;

            clearSubtitles(); 
            player.pause(); player.src = ""; player.load();

            const realTitle = titleCache[index];
            videoTitleBar.innerText = realTitle ? `${realTitle} (${file.name})` : file.name;

            player.src = URL.createObjectURL(file);
            player.playbackRate = 1.0;
            
            document.getElementById('speedBtnText').innerText = "1.0";
            document.getElementById('subStretchInput').value = ""; 
            subListContent.innerHTML = '<div style="color:#777; padding:10px;">ìë§‰ ì—†ìŒ</div>';

            const rawName = file.name;
            const baseName = (rawName.lastIndexOf('.') === -1 ? rawName : rawName.substring(0, rawName.lastIndexOf('.'))).toLowerCase();
            
            if (subtitleMap[baseName]) {
                readAndAttachSubtitle(subtitleMap[baseName], true);
            }

            modal.style.display = 'flex';
            player.controls = false;
            player.play().catch(() => {});
            updatePlayIcon();
        }

        function readAndAttachSubtitle(file, isAuto = false) {
            clearSubtitles(); 
            currentSubtitleKey = file.name; // ì €ì¥ í‚¤ë¡œ ì‚¬ìš©

            const reader = new FileReader();
            reader.onload = function(e) {
                let content = e.target.result;
                if (file.name.toLowerCase().endsWith('.srt')) content = srtToVtt(content);
                const blob = new Blob([content], { type: 'text/vtt' });
                const subUrl = URL.createObjectURL(blob);
                const track = document.createElement('track');
                track.kind = 'subtitles'; track.label = 'Korean'; track.srclang = 'ko'; track.src = subUrl; track.default = true;
                
                track.onload = function() {
                    const cues = this.track.cues;
                    
                    // 1. ì›ë³¸ ì‹œê°„ ì €ì¥ (í•„ìˆ˜: ë°°ìœ¨ ê³„ì‚° ê¸°ì¤€ì )
                    if (cues && cues.length > 0) {
                        for (let i = 0; i < cues.length; i++) {
                            // ì»¤ìŠ¤í…€ ì†ì„±ì— ì›ë³¸ ì‹œê°„ ì €ì¥
                            if(!cues[i]._originalStartTime) {
                                cues[i]._originalStartTime = cues[i].startTime;
                                cues[i]._originalEndTime = cues[i].endTime;
                            }
                            // ê²¹ì¹¨ ë°©ì§€ ì´ˆê¸° ì„¸íŒ…
                            cues[i].line = -2; cues[i].snapToLines = true;
                        }
                    }

                    // 2. ì €ì¥ëœ ì†ë„(Factor) ë¶ˆëŸ¬ì˜¤ê¸°
                    const savedFactor = loadSavedSubtitleFactor(currentSubtitleKey);
                    if (savedFactor) {
                        applySubtitleFactor(savedFactor, false); // ì €ì¥ëœ ê°’ ì ìš©
                        if(!isAuto) alert(`ì €ì¥ëœ ìë§‰ ì†ë„ ì ìš©ë¨: ${(100/savedFactor).toFixed(2)}%`);
                    }

                    renderSubList(cues); // ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
                    this.track.mode = 'showing';
                };
                player.appendChild(track);
                if(!isAuto && !localStorage.getItem('sub_factor_' + currentSubtitleKey)) {
                    alert(`ìë§‰ ì ìš©ë¨: ${file.name}`);
                    toggleMenu('subMenu');
                }
            };
            reader.readAsText(file, 'UTF-8');
        }
        function loadSubtitleManual(input) { if (input.files && input.files[0]) readAndAttachSubtitle(input.files[0], false); }
        function closeModal() { if (document.fullscreenElement) document.exitFullscreen(); modal.style.display = 'none'; player.pause(); clearSubtitles(); player.src = ""; }

        // ==========================================
        // 4. ìë§‰ ë¦¬ìŠ¤íŠ¸ & ì†ë„ ì‹±í¬ (í•µì‹¬ ë¡œì§)
        // ==========================================
        function toggleSubList() {
            const isVisible = subListModal.style.display === 'flex';
            subListModal.style.display = isVisible ? 'none' : 'flex';
            if(!isVisible) {
                const cues = getCues();
                if(cues) {
                    for(let i=0; i<cues.length; i++) {
                        if(cues[i].startTime <= player.currentTime && cues[i].endTime >= player.currentTime) {
                            const item = document.getElementById(`sub-item-${i}`);
                            if(item) item.scrollIntoView({block: 'center'});
                            break;
                        }
                    }
                }
            }
        }

        function renderSubList(cues) {
            if (!cues || cues.length === 0) return;
            let html = '';
            for (let i = 0; i < cues.length; i++) {
                const cue = cues[i];
                const text = cue.text.replace(/<[^>]*>/g, '');
                html += `
                    <div class="sub-item" id="sub-item-${i}" onclick="syncToSubtitleAsSpeed(${i})">
                        <span class="sub-time">${formatTime(cue.startTime)}</span>
                        <span>${text}</span>
                    </div>
                `;
            }
            subListContent.innerHTML = html;
        }

        // [í•µì‹¬] í´ë¦­ ì‹œ ìë§‰ ì†ë„(Factor) ê³„ì‚° ë° ì ìš©
        function syncToSubtitleAsSpeed(index) {
            const cues = getCues();
            if (!cues || !cues[index]) return;

            const selectedCue = cues[index];
            const originalStart = selectedCue._originalStartTime; // ì›ë³¸ ì‹œê°„ ê¸°ì¤€

            if (!originalStart || originalStart <= 0) {
                alert("ì‹œì‘ ì‹œê°„ì´ 0ì¸ ìë§‰ìœ¼ë¡œëŠ” ì†ë„ë¥¼ ê³„ì‚°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // í˜„ì¬ ë¹„ë””ì˜¤ ì‹œê°„ / ì›ë³¸ ìë§‰ ì‹œê°„ = ë°°ìœ¨(Factor)
            // ì˜ˆ: ì˜ìƒ 100ì´ˆ, ìë§‰ 98ì´ˆ -> 100/98 = 1.02 (ì‹œê°„ì„ 1.02ë°° ëŠ˜ë¦¼)
            const factor = player.currentTime / originalStart;

            // ì ìš© ë° ì €ì¥
            applySubtitleFactor(factor, true);
            
            // í”¼ë“œë°±
            document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`sub-item-${index}`).classList.add('active');
            
            const speedPercent = (100 / factor).toFixed(2);
            alert(`ì†ë„ ë™ê¸°í™” ì™„ë£Œ!\në°°ìœ¨: ${factor.toFixed(4)}\nìë§‰ ì†ë„: ${speedPercent}%\n(ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤)`);
        }

        function applySubtitleStretchManual() {
            const val = document.getElementById('subStretchInput').value;
            if(!val) return;
            const percentage = parseFloat(val);
            if (percentage <= 0) return alert("0ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
            
            // 98% ì†ë„ -> ì‹œê°„ì´ ê¸¸ì–´ì§ -> Factor = 100 / 98
            const factor = 100 / percentage;
            applySubtitleFactor(factor, true);
            alert(`ìˆ˜ë™ ì†ë„ ${percentage}% ì ìš© ì™„ë£Œ`);
        }

        function resetSubtitleFactor() {
            applySubtitleFactor(1.0, true);
            alert("ìë§‰ ì†ë„ ì´ˆê¸°í™” (100%)");
        }

        // ê³µí†µ ìë§‰ ë³€í™˜ í•¨ìˆ˜ (Factor ì ìš©)
        function applySubtitleFactor(factor, save) {
            const cues = getCues();
            if (!cues) return;

            for(let i=0; i<cues.length; i++){ 
                const cue = cues[i];
                // í•­ìƒ ì›ë³¸ ì‹œê°„(_originalStartTime)ì„ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°í•˜ì—¬ ì˜¤ì°¨ ëˆ„ì  ë°©ì§€
                if(cue._originalStartTime !== undefined) {
                    cue.startTime = cue._originalStartTime * factor;
                    cue.endTime = cue._originalEndTime * factor;
                }
                
                // ê²¹ì¹¨ ë°©ì§€ (Stacking Fix)
                cue.line = -2; 
                cue.snapToLines = true;
                if(i > 0) { 
                    const prevCue = cues[i-1];
                    if(prevCue.endTime > cue.startTime) prevCue.endTime = cue.startTime; 
                }
            }

            // ì €ì¥
            if(save && currentSubtitleKey) {
                localStorage.setItem('sub_factor_' + currentSubtitleKey, factor);
            }
        }

        function loadSavedSubtitleFactor(key) {
            const val = localStorage.getItem('sub_factor_' + key);
            return val ? parseFloat(val) : null;
        }

        function getCues() {
            const tracks = Array.from(player.textTracks).filter(t => t.mode === 'showing');
            return (tracks.length > 0) ? tracks[0].cues : null;
        }

        // ==========================================
        // 5. ì»¨íŠ¸ë¡¤ë°” & ì œìŠ¤ì²˜
        // ==========================================
        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.floor(seconds % 60);
            return `${m}:${s < 10 ? '0' : ''}${s}`;
        }
        player.addEventListener('loadedmetadata', () => {
            document.getElementById('durationText').innerText = formatTime(player.duration);
            seekBar.max = player.duration;
        });
        player.addEventListener('timeupdate', () => {
            if (!isDraggingSeek && !isTouching) { 
                seekBar.value = player.currentTime;
                document.getElementById('currentTimeText').innerText = formatTime(player.currentTime);
                // ë¦¬ìŠ¤íŠ¸ í™œì„±í™”
                const cues = getCues();
                if(cues && subListModal.style.display === 'flex') {
                    for(let i=0; i<cues.length; i++) {
                        if(cues[i].startTime <= player.currentTime && cues[i].endTime >= player.currentTime) {
                             document.querySelectorAll('.sub-item').forEach(el => el.classList.remove('active'));
                             const activeItem = document.getElementById(`sub-item-${i}`);
                             if(activeItem) activeItem.classList.add('active');
                             break;
                        }
                    }
                }
            }
        });
        seekBar.addEventListener('input', () => { 
            isDraggingSeek = true; 
            const val = parseFloat(seekBar.value);
            document.getElementById('currentTimeText').innerText = formatTime(val);
            if(!player.seeking) player.currentTime = val;
        });
        seekBar.addEventListener('change', () => { isDraggingSeek = false; player.currentTime = seekBar.value; });

        // ì œìŠ¤ì²˜
        videoWrapper.addEventListener('touchstart', onGestureStart, {passive: false});
        videoWrapper.addEventListener('touchmove', onGestureMove, {passive: false});
        videoWrapper.addEventListener('touchend', onGestureEnd);
        videoWrapper.addEventListener('mousedown', onGestureStart);
        videoWrapper.addEventListener('mousemove', onGestureMove);
        videoWrapper.addEventListener('mouseup', onGestureEnd);

        function onGestureStart(e) {
            if(e.target.closest('.controls-bar') || e.target.closest('.popup-menu') || e.target.closest('.sub-list-modal') || e.target.tagName === 'BUTTON') return;
            wasPlayingBeforeDrag = !player.paused;
            if(wasPlayingBeforeDrag) player.pause();
            touchStartX = (e.type === 'touchstart' ? e.touches[0].clientX : e.clientX);
            touchStartTime = player.currentTime;
            isTouching = true;
        }
        function onGestureMove(e) {
            if (!isTouching) return;
            e.preventDefault(); 
            const currentX = (e.type === 'touchmove' ? e.touches[0].clientX : e.clientX);
            const diffX = currentX - touchStartX;
            if (Math.abs(diffX) < 5) return;
            const timeDiff = diffX * SENSITIVITY;
            let targetTime = touchStartTime + timeDiff;
            if (targetTime < 0) targetTime = 0; if (targetTime > player.duration) targetTime = player.duration;
            seekBar.value = targetTime;
            document.getElementById('currentTimeText').innerText = formatTime(targetTime);
            gestureFeedback.style.opacity = '1'; gestureFeedback.innerText = formatTime(targetTime);
            if (!player.seeking) player.currentTime = targetTime;
        }
        function onGestureEnd(e) {
            if (isTouching) {
                isTouching = false; gestureFeedback.style.opacity = '0';
                if(wasPlayingBeforeDrag) player.play();
            }
        }

        // ê³µí†µ ê¸°ëŠ¥
        function toggleControls() {
            const bar = document.getElementById('controlsBar'); const titleBar = document.getElementById('videoTitleBar');
            if (bar.style.opacity === '0') { bar.style.opacity = '1'; bar.style.pointerEvents = 'auto'; titleBar.style.opacity = '1'; }
            else { bar.style.opacity = '0'; bar.style.pointerEvents = 'none'; titleBar.style.opacity = '0'; document.querySelectorAll('.popup-menu').forEach(el => el.style.display = 'none'); }
        }
        function toggleMenu(menuId) {
            const menu = document.getElementById(menuId); const isVisible = menu.style.display === 'flex';
            document.querySelectorAll('.popup-menu').forEach(el => el.style.display = 'none'); 
            subListModal.style.display = 'none'; 
            if (!isVisible) menu.style.display = 'flex';
        }
        function togglePlay() { if (player.paused) player.play(); else player.pause(); updatePlayIcon(); }
        player.addEventListener('play', updatePlayIcon); player.addEventListener('pause', updatePlayIcon);
        function updatePlayIcon() { playIcon.innerText = player.paused ? "â–¶" : "â¸"; }
        function seek(sec) { player.currentTime += sec; }
        function setSpeed(rate) { player.playbackRate = rate; document.getElementById('speedBtnText').innerText = rate; toggleMenu('speedMenu'); }
        function toggleFullscreen() { if (!document.fullscreenElement) videoWrapper.requestFullscreen().catch(() => {}); else document.exitFullscreen(); }
        
        function srtToVtt(srt) { return "WEBVTT\n\n" + srt.replace(/(\d{2}):(\d{2}):(\d{2}),(\d{3})/g, '$1:$2:$3.$4'); }
    </script>
</body>
</html>
